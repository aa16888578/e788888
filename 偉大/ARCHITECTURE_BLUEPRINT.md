# ğŸ—ï¸ å¤šå¹³å°é›»å•†ç³»çµ±æ¶æ§‹è—åœ–

## ğŸ“‹ **å°ˆæ¡ˆæ¦‚è¿°**
é€™æ˜¯ä¸€å€‹å‰µæ–°çš„å¤šå¹³å°é›»å•†ç®¡ç†ç³»çµ±ï¼Œæ•´åˆäº† Telegram æ©Ÿå™¨äººã€MiniWeb è¼•é‡ç¶²é å’Œå®Œæ•´çš„ç¶²ç«™ç®¡ç†å¾Œå°ã€‚ç³»çµ±æ¡ç”¨ç¾ä»£åŒ–æŠ€è¡“æ£§ï¼Œæä¾›å…¨æ–¹ä½çš„é›»å•†è§£æ±ºæ–¹æ¡ˆã€‚

---

## ğŸ¨ **å¤šå¹³å°æ¶æ§‹ (Multi-Platform Architecture)**

### **1. å¹³å°çµ„æˆ (Platform Components)**

#### **1.1 Telegram æ©Ÿå™¨äººç§äººèŠå¤©çª—å£** ğŸ¤–
- **åŠŸèƒ½å®šä½**ï¼šå€‹äººè³¼ç‰©åŠ©æ‰‹ã€å®¢æœæ”¯æŒã€å¿«é€Ÿä¸‹å–®
- **æŠ€è¡“æ¶æ§‹**ï¼šTelegram Bot API + Firebase å¾Œç«¯
- **æ ¸å¿ƒç‰¹æ€§**ï¼š
  - æ™ºèƒ½å•†å“æ¨è–¦
  - ä¸€å°ä¸€å®¢æœå°è©±
  - è³¼ç‰©è»Šç®¡ç†
  - è¨‚å–®è¿½è¹¤
  - æ”¯ä»˜é›†æˆ

#### **1.2 MiniWeb è¼•é‡ç¶²é ** ğŸŒ
- **åŠŸèƒ½å®šä½**ï¼šå¿«é€Ÿç€è¦½ã€ç°¡å–®æ“ä½œã€åˆ†äº«éˆæ¥
- **æŠ€è¡“æ¶æ§‹**ï¼šPWA + éŸ¿æ‡‰å¼è¨­è¨ˆ + Firebase
- **æ ¸å¿ƒç‰¹æ€§**ï¼š
  - è¼•é‡ç´šç•Œé¢
  - å¿«é€ŸåŠ è¼‰
  - é›¢ç·šåŠŸèƒ½
  - ç§»å‹•ç«¯å„ªåŒ–
  - ç¤¾äº¤åˆ†äº«

#### **1.3 ç¶²ç«™ç®¡ç†å¾Œå°** ğŸ–¥ï¸
- **åŠŸèƒ½å®šä½**ï¼šå®Œæ•´çš„é›»å•†ç®¡ç†ç³»çµ±
- **æŠ€è¡“æ¶æ§‹**ï¼šNext.js 15 + TypeScript + Tailwind CSS
- **æ ¸å¿ƒç‰¹æ€§**ï¼š
  - å•†å“ç®¡ç†
  - è¨‚å–®è™•ç†
  - ç”¨æˆ¶ç®¡ç†
  - æ•¸æ“šåˆ†æ
  - ç³»çµ±ç›£æ§

#### **1.4 ä»£ç†ç³»çµ±** ğŸ¢
- **åŠŸèƒ½å®šä½**ï¼šå¤šå±¤ç´šä»£ç†åˆ†éŠ·ç®¡ç†
- **æŠ€è¡“æ¶æ§‹**ï¼šFirebase + ä»£ç†ç®¡ç†æ¨¡çµ„
- **æ ¸å¿ƒç‰¹æ€§**ï¼š
  - å¤šå±¤ç´šä»£ç†æ¶æ§‹
  - ä½£é‡‘è¨ˆç®—ç³»çµ±
  - ä»£ç†æ¥­ç¸¾è¿½è¹¤
  - åˆ†éŠ·ç¶²çµ¡ç®¡ç†
  - ä»£ç†æ¿€å‹µæ©Ÿåˆ¶

#### **1.5 æ”¯ä»˜ç³»çµ±** ğŸ’°
- **åŠŸèƒ½å®šä½**ï¼šUSDT-TRC20 åŠ å¯†è²¨å¹£æ”¯ä»˜è™•ç†
- **æŠ€è¡“æ¶æ§‹**ï¼šTron å€å¡Šéˆ + æ™ºèƒ½åˆç´„ + æ”¯ä»˜ç¶²é—œ
- **æ ¸å¿ƒç‰¹æ€§**ï¼š
  - USDT-TRC20 æ”¯ä»˜è™•ç†
  - æ™ºèƒ½åˆç´„è‡ªå‹•åŒ–
  - å¯¦æ™‚åŒ¯ç‡è½‰æ›
  - å¤šå¹£ç¨®æ”¯æŒ
  - å®‰å…¨æ”¯ä»˜é©—è­‰

### **2. æŠ€è¡“æ£§ (Tech Stack)**
```
Frontend Framework: Next.js 15.5.0
Language: TypeScript 5
Styling: Tailwind CSS 4
State Management: React Hooks + Context API
Backend: Firebase (Firestore, Functions, Storage, Auth)
Bot Platform: Telegram Bot API
PWA: Service Workers + Web App Manifest
Database: Firestore + Realtime Database
Hosting: Firebase Hosting + Vercel
Blockchain: Tron Network (TRC20)
Payment: USDT-TRC20 + Smart Contracts
```

---

## ğŸ¤– **Telegram Bot æ¶æ§‹ (Telegram Bot Architecture)**

### **1. Bot åŠŸèƒ½æ¶æ§‹**
```typescript
interface TelegramBotFeatures {
  // å•†å“ç›¸é—œ
  productSearch: 'search by name, category, price range';
  productRecommendation: 'AI-powered recommendations';
  productDetails: 'detailed product information';
  
  // è³¼ç‰©åŠŸèƒ½
  shoppingCart: 'add, remove, view cart items';
  orderManagement: 'place, track, cancel orders';
  paymentIntegration: 'secure payment processing';
  
  // å®¢æœåŠŸèƒ½
  customerService: '24/7 automated support';
  orderTracking: 'real-time order status';
  returnRefund: 'return and refund requests';
  
  // ç”¨æˆ¶ç®¡ç†
  userProfile: 'personal information management';
  orderHistory: 'complete order records';
  preferences: 'shopping preferences and settings';
}
```

### **2. Bot å°è©±æµç¨‹è¨­è¨ˆ**
```mermaid
graph TD
    A[ç”¨æˆ¶é–‹å§‹å°è©±] --> B[æ­¡è¿è¨Šæ¯]
    B --> C[ä¸»é¸å–®]
    C --> D[å•†å“ç€è¦½]
    C --> E[è³¼ç‰©è»Š]
    C --> F[è¨‚å–®ç®¡ç†]
    C --> G[å®¢æœæ”¯æ´]
    
    D --> H[å•†å“æœå°‹]
    D --> I[åˆ†é¡ç€è¦½]
    D --> J[å•†å“è©³æƒ…]
    
    E --> K[åŠ å…¥è³¼ç‰©è»Š]
    E --> L[æŸ¥çœ‹è³¼ç‰©è»Š]
    E --> M[çµå¸³æµç¨‹]
    
    F --> N[è¨‚å–®ç‹€æ…‹]
    F --> O[è¨‚å–®æ­·å²]
    F --> P[é€€è²¨ç”³è«‹]
```

### **3. Bot æŠ€è¡“å¯¦ç¾**
```typescript
// Bot æ ¸å¿ƒé…ç½®
const botConfig = {
  token: process.env.TELEGRAM_BOT_TOKEN,
  webhook: process.env.WEBHOOK_URL,
  commands: [
    { command: '/start', description: 'é–‹å§‹ä½¿ç”¨è³¼ç‰©åŠ©æ‰‹' },
    { command: '/products', description: 'ç€è¦½å•†å“' },
    { command: '/cart', description: 'æŸ¥çœ‹è³¼ç‰©è»Š' },
    { command: '/orders', description: 'è¨‚å–®ç®¡ç†' },
    { command: '/help', description: 'å®¢æœæ”¯æ´' }
  ]
};

// å°è©±ç‹€æ…‹ç®¡ç†
interface ChatState {
  userId: number;
  currentState: 'main_menu' | 'product_browsing' | 'cart' | 'checkout';
  context: any;
  lastActivity: Date;
}
```

---

## ğŸŒ **MiniWeb æ¶æ§‹ (MiniWeb Architecture)**

### **1. PWA åŠŸèƒ½è¨­è¨ˆ**
```typescript
// Service Worker é…ç½®
const swConfig = {
  name: 'ShopBot MiniWeb',
  version: '1.0.0',
  cacheStrategy: 'stale-while-revalidate',
  offlineFallback: '/offline.html',
  runtimeCaching: [
    {
      urlPattern: /^https:\/\/api\.shopbot\.com/,
      handler: 'networkFirst',
      options: { cacheName: 'api-cache' }
    },
    {
      urlPattern: /\.(png|jpg|jpeg|svg|gif)$/,
      handler: 'cacheFirst',
      options: { cacheName: 'image-cache' }
    }
  ]
};

// Web App Manifest
const manifest = {
  name: 'ShopBot',
  short_name: 'ShopBot',
  description: 'è¼•é‡ç´šé›»å•†è³¼ç‰©é«”é©—',
  start_url: '/',
  display: 'standalone',
  theme_color: '#4285f4',
  background_color: '#ffffff',
  icons: [
    { src: '/icon-192.png', sizes: '192x192', type: 'image/png' },
    { src: '/icon-512.png', sizes: '512x512', type: 'image/png' }
  ]
};
```

### **2. éŸ¿æ‡‰å¼è¨­è¨ˆæ¶æ§‹**
```css
/* æ–·é»è¨­è¨ˆ */
:root {
  --mobile: 320px;
  --tablet: 768px;
  --desktop: 1024px;
  --large: 1440px;
}

/* éŸ¿æ‡‰å¼ç¶²æ ¼ç³»çµ± */
.product-grid {
  display: grid;
  gap: 1rem;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
}

/* ç§»å‹•ç«¯å„ªå…ˆè¨­è¨ˆ */
.container {
  width: 100%;
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 1rem;
}

@media (min-width: 768px) {
  .container {
    padding: 0 2rem;
  }
}
```

### **3. æ€§èƒ½å„ªåŒ–ç­–ç•¥**
```typescript
// åœ–ç‰‡æ‡¶åŠ è¼‰
const lazyLoadImages = () => {
  const imageObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const img = entry.target as HTMLImageElement;
        img.src = img.dataset.src!;
        imageObserver.unobserve(img);
      }
    });
  });
  
  document.querySelectorAll('img[data-src]').forEach(img => {
    imageObserver.observe(img);
  });
};

// ä»£ç¢¼åˆ†å‰²
const ProductPage = lazy(() => import('./pages/ProductPage'));
const CartPage = lazy(() => import('./pages/CartPage'));
const CheckoutPage = lazy(() => import('./pages/CheckoutPage'));
```

---

## ğŸ–¥ï¸ **ç¶²ç«™ç®¡ç†å¾Œå°æ¶æ§‹ (Admin Dashboard Architecture)**

### **1. ç®¡ç†åŠŸèƒ½æ¨¡çµ„**
```typescript
interface AdminModules {
  // å•†å“ç®¡ç†
  productManagement: {
    create: 'æ–°å¢å•†å“';
    edit: 'ç·¨è¼¯å•†å“';
    delete: 'åˆªé™¤å•†å“';
    bulk: 'æ‰¹é‡æ“ä½œ';
    categories: 'åˆ†é¡ç®¡ç†';
    inventory: 'åº«å­˜ç®¡ç†';
  };
  
  // è¨‚å–®ç®¡ç†
  orderManagement: {
    view: 'æŸ¥çœ‹è¨‚å–®';
    process: 'è™•ç†è¨‚å–®';
    ship: 'ç™¼è²¨ç®¡ç†';
    refund: 'é€€æ¬¾è™•ç†';
    analytics: 'è¨‚å–®åˆ†æ';
  };
  
  // ç”¨æˆ¶ç®¡ç†
  userManagement: {
    list: 'ç”¨æˆ¶åˆ—è¡¨';
    details: 'ç”¨æˆ¶è©³æƒ…';
    permissions: 'æ¬Šé™ç®¡ç†';
    activity: 'æ´»å‹•è¨˜éŒ„';
    support: 'å®¢æœè¨˜éŒ„';
  };
  
  // æ•¸æ“šåˆ†æ
  analytics: {
    sales: 'éŠ·å”®æ•¸æ“š';
    traffic: 'æµé‡åˆ†æ';
    conversion: 'è½‰æ›ç‡';
    revenue: 'æ”¶å…¥åˆ†æ';
    trends: 'è¶¨å‹¢é æ¸¬';
  };
}
```

### **2. å„€è¡¨æ¿è¨­è¨ˆ**
```typescript
// å¯¦æ™‚æ•¸æ“šç›£æ§
interface DashboardMetrics {
  realTime: {
    activeUsers: number;
    currentOrders: number;
    revenue: number;
    conversionRate: number;
  };
  
  daily: {
    sales: number;
    orders: number;
    newUsers: number;
    pageViews: number;
  };
  
  weekly: {
    growth: number;
    topProducts: Product[];
    userRetention: number;
    averageOrderValue: number;
  };
}

// åœ–è¡¨é…ç½®
const chartConfig = {
  sales: {
    type: 'line',
    data: salesData,
    options: {
      responsive: true,
      plugins: {
        title: { display: true, text: 'éŠ·å”®è¶¨å‹¢' }
      }
    }
  },
  
  products: {
    type: 'doughnut',
    data: productData,
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom' }
      }
    }
  }
};
```

---

## ğŸ”§ **å¾Œå°æ¶æ§‹ (Backend Architecture)**

### **1. Firebase æœå‹™æ¶æ§‹**
```typescript
// Firestore æ•¸æ“šçµæ§‹
interface FirestoreCollections {
  products: {
    id: string;
    name: string;
    category: string;
    price: number;
    stock: number;
    description: string;
    images: string[];
    status: 'active' | 'inactive' | 'deleted';
    createdAt: Timestamp;
    updatedAt: Timestamp;
  };
  
  orders: {
    id: string;
    userId: string;
    products: OrderProduct[];
    total: number;
    status: 'pending' | 'processing' | 'shipped' | 'delivered' | 'cancelled';
    paymentStatus: 'pending' | 'paid' | 'failed' | 'refunded';
    shippingAddress: Address;
    createdAt: Timestamp;
    updatedAt: Timestamp;
  };
  
  users: {
    id: string;
    telegramId: number;                    // Telegram ç”¨æˆ¶ ID (ä¸»è¦æ¨™è­˜ç¬¦)
    username?: string;                     // Telegram ç”¨æˆ¶å (å¯é¸)
    firstName: string;                     // ç”¨æˆ¶åå­—
    lastName?: string;                     // ç”¨æˆ¶å§“æ° (å¯é¸)
    languageCode?: string;                 // ç”¨æˆ¶èªè¨€åå¥½
    role: 'admin' | 'user' | 'moderator'; // ç”¨æˆ¶è§’è‰²
    status: 'active' | 'inactive' | 'suspended'; // ç”¨æˆ¶ç‹€æ…‹
    permissions: string[];                 // æ¬Šé™é™£åˆ—
    lastLogin: Timestamp;                  // æœ€å¾Œç™»å…¥æ™‚é–“
    createdAt: Timestamp;                  // å‰µå»ºæ™‚é–“
    updatedAt: Timestamp;                  // æ›´æ–°æ™‚é–“
  };
}

// Cloud Functions æ¶æ§‹
interface CloudFunctions {
  // Telegram Bot ç›¸é—œ
  telegramWebhook: 'è™•ç† Telegram æ›´æ–°';
  sendMessage: 'ç™¼é€ Telegram è¨Šæ¯';
  processCommand: 'è™•ç† Bot å‘½ä»¤';
  
  // é›»å•†åŠŸèƒ½
  createOrder: 'å‰µå»ºè¨‚å–®';
  updateInventory: 'æ›´æ–°åº«å­˜';
  processPayment: 'è™•ç†æ”¯ä»˜';
  sendNotification: 'ç™¼é€é€šçŸ¥';
  
  // ç®¡ç†åŠŸèƒ½
  generateReport: 'ç”Ÿæˆå ±è¡¨';
  backupData: 'æ•¸æ“šå‚™ä»½';
  syncInventory: 'åº«å­˜åŒæ­¥';
}
```

### **2. API æ¶æ§‹è¨­è¨ˆ**
```typescript
// RESTful API ç«¯é»
const apiEndpoints = {
  // å•†å“ API
  products: {
    GET: '/api/products',           // ç²å–å•†å“åˆ—è¡¨
    POST: '/api/products',          // å‰µå»ºå•†å“
    PUT: '/api/products/:id',       // æ›´æ–°å•†å“
    DELETE: '/api/products/:id',    // åˆªé™¤å•†å“
    PATCH: '/api/products/:id',     // éƒ¨åˆ†æ›´æ–°
  },
  
  // è¨‚å–® API
  orders: {
    GET: '/api/orders',             // ç²å–è¨‚å–®åˆ—è¡¨
    POST: '/api/orders',            // å‰µå»ºè¨‚å–®
    PUT: '/api/orders/:id',         // æ›´æ–°è¨‚å–®
    PATCH: '/api/orders/:id/status', // æ›´æ–°è¨‚å–®ç‹€æ…‹
  },
  
  // ç”¨æˆ¶ API
  users: {
    GET: '/api/users',              // ç²å–ç”¨æˆ¶åˆ—è¡¨
    POST: '/api/users',             // å‰µå»ºç”¨æˆ¶
    PUT: '/api/users/:id',          // æ›´æ–°ç”¨æˆ¶
    DELETE: '/api/users/:id',       // åˆªé™¤ç”¨æˆ¶
  },
  
  // Telegram Bot API
  telegram: {
    POST: '/api/telegram/webhook',  // Webhook è™•ç†
    POST: '/api/telegram/send',     // ç™¼é€è¨Šæ¯
    GET: '/api/telegram/status',    // Bot ç‹€æ…‹
  }
};

// éŸ¿æ‡‰æ ¼å¼æ¨™æº–
interface ApiResponse<T> {
  success: boolean;
  data?: T;
  message?: string;
  error?: string;
  timestamp: string;
  requestId: string;
}
```

---

## ğŸš€ **éƒ¨ç½²æ¶æ§‹ (Deployment Architecture)**

### **1. å¤šå¹³å°éƒ¨ç½²ç­–ç•¥**
```bash
# 1. Firebase å¾Œç«¯éƒ¨ç½²
firebase deploy --only functions,firestore,storage,hosting

# 2. Telegram Bot éƒ¨ç½²
# è¨­ç½® webhook åˆ° Firebase Functions
curl -F "url=https://your-project.cloudfunctions.net/telegramWebhook" \
     https://api.telegram.org/bot<BOT_TOKEN>/setWebhook

# 3. MiniWeb éƒ¨ç½²
# éƒ¨ç½²åˆ° Firebase Hosting
firebase deploy --only hosting

# 4. ç®¡ç†å¾Œå°éƒ¨ç½²
# éƒ¨ç½²åˆ° Vercel
vercel --prod
```

### **2. ç’°å¢ƒé…ç½®**
```typescript
// ç’°å¢ƒè®Šæ•¸é…ç½®
const environmentConfig = {
  development: {
    firebase: {
      projectId: 'shopbot-dev',
      apiKey: process.env.FIREBASE_API_KEY_DEV,
      authDomain: 'shopbot-dev.firebaseapp.com'
    },
    telegram: {
      botToken: process.env.TELEGRAM_BOT_TOKEN_DEV,
      webhookUrl: 'https://dev-api.shopbot.com/telegram/webhook'
    }
  },
  
  production: {
    firebase: {
      projectId: 'shopbot-prod',
      apiKey: process.env.FIREBASE_API_KEY_PROD,
      authDomain: 'shopbot-prod.firebaseapp.com'
    },
    telegram: {
      botToken: process.env.TELEGRAM_BOT_TOKEN_PROD,
      webhookUrl: 'https://api.shopbot.com/telegram/webhook'
    }
  }
};
```

---

## ğŸ“Š **æ•¸æ“šæµæ¶æ§‹ (Data Flow Architecture)**

### **1. å¤šå¹³å°æ•¸æ“šåŒæ­¥**
```mermaid
graph TD
    A[Telegram Bot] --> B[Firebase Functions]
    C[MiniWeb] --> B
    D[ç®¡ç†å¾Œå°] --> B
    B --> E[Firestore Database]
    B --> F[Cloud Storage]
    B --> G[Authentication]
    
    H[ç”¨æˆ¶æ“ä½œ] --> I[æ•¸æ“šæ›´æ–°]
    I --> J[å¯¦æ™‚åŒæ­¥]
    J --> K[å¤šå¹³å°æ›´æ–°]
    
    L[è¨‚å–®å‰µå»º] --> M[åº«å­˜æ›´æ–°]
    M --> N[é€šçŸ¥ç™¼é€]
    N --> O[Telegram é€šçŸ¥]
    N --> P[Email é€šçŸ¥]
    N --> Q[ç®¡ç†å¾Œå°æ›´æ–°]
```

### **2. å¯¦æ™‚æ•¸æ“šæµ**
```typescript
// Firestore å¯¦æ™‚ç›£è½
const realtimeDataSync = {
  // è¨‚å–®ç‹€æ…‹ç›£è½
  orderStatus: onSnapshot(
    doc(db, 'orders', orderId),
    (doc) => {
      const orderData = doc.data();
      updateOrderStatus(orderData);
      notifyUser(orderData);
      updateAdminDashboard(orderData);
    }
  ),
  
  // åº«å­˜è®ŠåŒ–ç›£è½
  inventoryChanges: onSnapshot(
    collection(db, 'products'),
    (snapshot) => {
      snapshot.docChanges().forEach((change) => {
        if (change.type === 'modified') {
          updateInventoryDisplay(change.doc.data());
          checkLowStock(change.doc.data());
        }
      });
    }
  )
};
```

---

## ğŸ”’ **å®‰å…¨æ¶æ§‹ (Security Architecture)**

### **1. åŸºæ–¼ Telegram çš„ç”¨æˆ¶èªè­‰æ¶æ§‹**
```typescript
// Telegram ç”¨æˆ¶èªè­‰æµç¨‹
interface TelegramAuthFlow {
  // 1. ç”¨æˆ¶é€šé Telegram Bot é–‹å§‹å°è©±
  startConversation: {
    trigger: '/start command or first message';
    action: 'create or retrieve user profile';
    data: 'extract telegram user info';
  };
  
  // 2. ç”¨æˆ¶èº«ä»½é©—è­‰
  userAuthentication: {
    method: 'telegram user ID verification';
    validation: 'check telegram user exists and is active';
    session: 'create secure session token';
  };
  
  // 3. æ¬Šé™ç®¡ç†
  authorization: {
    role: 'admin | user | moderator';
    permissions: 'feature-based access control';
    scope: 'user-specific data access';
  };
}

// ç”¨æˆ¶é©—è­‰ä¸­é–“ä»¶
const telegramAuthMiddleware = {
  // é©—è­‰ Telegram ç”¨æˆ¶èº«ä»½
  verifyUser: (telegramId: number) => {
    return firebase.firestore()
      .collection('users')
      .where('telegramId', '==', telegramId)
      .where('status', '==', 'active')
      .get();
  },
  
  // æª¢æŸ¥ç”¨æˆ¶æ¬Šé™
  checkPermission: (userId: string, permission: string) => {
    return firebase.firestore()
      .collection('users')
      .doc(userId)
      .get()
      .then(doc => {
        const user = doc.data();
        return user?.permissions?.includes(permission) || false;
      });
  }
};
```

### **2. å¤šå¹³å°å®‰å…¨ç­–ç•¥**
```typescript
// èªè­‰èˆ‡æˆæ¬Š - åŸºæ–¼ Telegram ç”¨æˆ¶è³‡è¨Š
const securityConfig = {
  // Telegram ç”¨æˆ¶èªè­‰
  telegram: {
    webhookSecret: process.env.TELEGRAM_WEBHOOK_SECRET,
    allowedUsers: process.env.ALLOWED_TELEGRAM_USERS?.split(','),
    rateLimit: { maxRequests: 100, windowMs: 60000 },
    // ä½¿ç”¨ Telegram ç”¨æˆ¶è³‡è¨Šé€²è¡Œèº«ä»½é©—è­‰
    userVerification: {
      telegramId: 'primary identifier',
      username: 'optional display name',
      firstName: 'user first name',
      lastName: 'user last name',
      languageCode: 'user language preference'
    }
  },
  
  // API å®‰å…¨
  api: {
    rateLimit: { maxRequests: 1000, windowMs: 900000 },
    cors: { origin: process.env.ALLOWED_ORIGINS?.split(',') },
    helmet: true,
    // åŸºæ–¼ Telegram ç”¨æˆ¶çš„èªè­‰
    authentication: 'telegram-based',
    authorization: 'role-based-permissions'
  }
};

// æ•¸æ“šåŠ å¯†
const encryptionConfig = {
  algorithm: 'aes-256-gcm',
  keyLength: 32,
  ivLength: 16,
  saltLength: 64
};
```

---

## ğŸ“ˆ **ç›£æ§èˆ‡ç¶­è­·æ¶æ§‹ (Monitoring & Maintenance)**

### **1. å¤šå¹³å°ç›£æ§**
```typescript
// æ€§èƒ½ç›£æ§
const monitoringConfig = {
  // Firebase æ€§èƒ½ç›£æ§
  firebase: {
    performance: true,
    analytics: true,
    crashlytics: true
  },
  
  // Telegram Bot ç›£æ§
  telegram: {
    messageDelivery: true,
    responseTime: true,
    errorTracking: true,
    userEngagement: true
  },
  
  // ç¶²ç«™æ€§èƒ½ç›£æ§
  web: {
    pageLoadTime: true,
    apiResponseTime: true,
    userExperience: true,
    conversionTracking: true
  }
};

// æ—¥èªŒè¨˜éŒ„
const loggingConfig = {
  levels: ['error', 'warn', 'info', 'debug'],
  destinations: ['console', 'firebase', 'external'],
  retention: '30 days',
  format: 'json'
};
```

---

## ğŸ’° **æ”¯ä»˜ç³»çµ±æ¶æ§‹ (Payment System Architecture)**

### **1. USDT-TRC20 æ”¯ä»˜æ ¸å¿ƒæ¶æ§‹**
```typescript
// æ”¯ä»˜ç³»çµ±æ•¸æ“šçµæ§‹
interface PaymentSystem {
  // æ”¯ä»˜æ–¹å¼
  paymentMethods: {
    usdtTrc20: 'USDT-TRC20 æ”¯ä»˜ (ä¸»è¦)';
    usdtErc20: 'USDT-ERC20 æ”¯ä»˜ (å‚™ç”¨)';
    trx: 'TRX åŸç”Ÿä»£å¹£æ”¯ä»˜';
  };
  
  // æ”¯ä»˜ç‹€æ…‹
  paymentStatus: {
    pending: 'ç­‰å¾…æ”¯ä»˜';
    processing: 'è™•ç†ä¸­';
    confirmed: 'å·²ç¢ºèª';
    failed: 'æ”¯ä»˜å¤±æ•—';
    expired: 'å·²éæœŸ';
    refunded: 'å·²é€€æ¬¾';
  };
  
  // æ”¯ä»˜é¡å‹
  paymentTypes: {
    order: 'è¨‚å–®æ”¯ä»˜';
    deposit: 'å……å€¼';
    withdrawal: 'æç¾';
    refund: 'é€€æ¬¾';
    commission: 'ä½£é‡‘æ”¯ä»˜';
  };
}

// æ”¯ä»˜è¨‚å–®æ•¸æ“šçµæ§‹
interface PaymentOrder {
  id: string;
  orderId: string;                       // é—œè¯è¨‚å–® ID
  userId: string;                        // ç”¨æˆ¶ ID
  agentId?: string;                      // ä»£ç† ID (å¦‚æœæœ‰)
  amount: number;                        // æ”¯ä»˜é‡‘é¡ (USDT)
  amountFiat: number;                    // ç­‰å€¼æ³•å¹£é‡‘é¡
  exchangeRate: number;                  // åŒ¯ç‡
  currency: 'USD' | 'CNY' | 'TWD';      // æ³•å¹£é¡å‹
  paymentMethod: 'usdt_trc20' | 'usdt_erc20' | 'trx';
  walletAddress: string;                 // æ”¶æ¬¾éŒ¢åŒ…åœ°å€
  userWalletAddress?: string;            // ç”¨æˆ¶éŒ¢åŒ…åœ°å€
  transactionHash?: string;              // å€å¡Šéˆäº¤æ˜“å“ˆå¸Œ
  blockNumber?: number;                  // å€å¡Šè™Ÿ
  confirmations: number;                 // ç¢ºèªæ•¸
  requiredConfirmations: number;         // æ‰€éœ€ç¢ºèªæ•¸ (TRC20: 20)
  paymentStatus: 'pending' | 'processing' | 'confirmed' | 'failed' | 'expired' | 'refunded';
  expiresAt: Timestamp;                  // æ”¯ä»˜éæœŸæ™‚é–“
  paidAt?: Timestamp;                    // æ”¯ä»˜å®Œæˆæ™‚é–“
  createdAt: Timestamp;
  updatedAt: Timestamp;
}

// éŒ¢åŒ…ç®¡ç†æ•¸æ“šçµæ§‹
interface WalletManagement {
  // ç³»çµ±éŒ¢åŒ…
  systemWallets: {
    hotWallet: {
      address: string;                   // ç†±éŒ¢åŒ…åœ°å€
      balance: number;                   // é¤˜é¡
      purpose: 'æ—¥å¸¸æ”¶æ¬¾å’Œæ”¯ä»˜';
      security: 'å¤šç°½åä¿è­·';
    };
    coldWallet: {
      address: string;                   // å†·éŒ¢åŒ…åœ°å€
      balance: number;                   // é¤˜é¡
      purpose: 'é•·æœŸå­˜å„²';
      security: 'é›¢ç·šå­˜å„²';
    };
    commissionWallet: {
      address: string;                   // ä½£é‡‘éŒ¢åŒ…åœ°å€
      balance: number;                   // é¤˜é¡
      purpose: 'ä»£ç†ä½£é‡‘æ”¯ä»˜';
      security: 'è‡ªå‹•åŒ–æ”¯ä»˜';
    };
  };
  
  // ç”¨æˆ¶éŒ¢åŒ…
  userWallets: {
    id: string;
    userId: string;
    walletAddress: string;               // ç”¨æˆ¶éŒ¢åŒ…åœ°å€
    walletType: 'tron' | 'ethereum';
    isVerified: boolean;                 // æ˜¯å¦é©—è­‰
    balance: number;                     // é¤˜é¡
    lastSync: Timestamp;                 // æœ€å¾ŒåŒæ­¥æ™‚é–“
    createdAt: Timestamp;
    updatedAt: Timestamp;
  };
}
```

### **2. æ™ºèƒ½åˆç´„æ¶æ§‹**
```typescript
// æ™ºèƒ½åˆç´„æ¥å£
interface SmartContractInterface {
  // æ”¯ä»˜åˆç´„
  paymentContract: {
    name: 'ShopBotPayment';
    network: 'Tron Mainnet';
    address: string;
    functions: [
      'createPayment(uint256 orderId, uint256 amount)',
      'confirmPayment(bytes32 paymentId)',
      'refundPayment(bytes32 paymentId)',
      'getPaymentStatus(bytes32 paymentId)',
      'withdrawFunds(address to, uint256 amount)'
    ];
  };
  
  // ä»£ç†ä½£é‡‘åˆç´„
  commissionContract: {
    name: 'AgentCommission';
    network: 'Tron Mainnet';
    address: string;
    functions: [
      'distributeCommission(address agent, uint256 amount)',
      'claimCommission(address agent)',
      'getCommissionBalance(address agent)',
      'withdrawCommission(address agent, uint256 amount)'
    ];
  };
  
  // åŒ¯ç‡é è¨€æ©Ÿåˆç´„
  oracleContract: {
    name: 'PriceOracle';
    network: 'Tron Mainnet';
    address: string;
    functions: [
      'getUSDTPrice(string currency)',
      'updatePrice(string currency, uint256 price)',
      'getLastUpdateTime(string currency)'
    ];
  };
}

// æ™ºèƒ½åˆç´„äº‹ä»¶
interface ContractEvents {
  // æ”¯ä»˜äº‹ä»¶
  paymentEvents: {
    PaymentCreated: 'event PaymentCreated(bytes32 indexed paymentId, uint256 orderId, uint256 amount)';
    PaymentConfirmed: 'event PaymentConfirmed(bytes32 indexed paymentId, address indexed user, uint256 amount)';
    PaymentRefunded: 'event PaymentRefunded(bytes32 indexed paymentId, uint256 amount)';
    PaymentExpired: 'event PaymentExpired(bytes32 indexed paymentId)';
  };
  
  // ä½£é‡‘äº‹ä»¶
  commissionEvents: {
    CommissionDistributed: 'event CommissionDistributed(address indexed agent, uint256 amount)';
    CommissionClaimed: 'event CommissionClaimed(address indexed agent, uint256 amount)';
    CommissionWithdrawn: 'event CommissionWithdrawn(address indexed agent, uint256 amount)';
  };
}
```

### **3. æ”¯ä»˜æµç¨‹è¨­è¨ˆ**
```typescript
// æ”¯ä»˜æµç¨‹ç‹€æ…‹æ©Ÿ
interface PaymentFlow {
  // 1. å‰µå»ºæ”¯ä»˜
  createPayment: {
    trigger: 'ç”¨æˆ¶é¸æ“‡å•†å“ä¸¦çµå¸³';
    action: 'ç”Ÿæˆæ”¯ä»˜è¨‚å–®å’Œ QR ç¢¼';
    data: 'è¨‚å–®é‡‘é¡ã€åŒ¯ç‡ã€éæœŸæ™‚é–“';
    nextState: 'waiting_payment';
  };
  
  // 2. ç­‰å¾…æ”¯ä»˜
  waitingPayment: {
    trigger: 'æ”¯ä»˜è¨‚å–®å‰µå»ºå®Œæˆ';
    action: 'ç›£æ§å€å¡Šéˆäº¤æ˜“';
    data: 'éŒ¢åŒ…åœ°å€ã€é‡‘é¡ã€ç¢ºèªæ•¸';
    nextState: 'payment_confirmed' | 'payment_expired';
  };
  
  // 3. æ”¯ä»˜ç¢ºèª
  paymentConfirmed: {
    trigger: 'é”åˆ°æ‰€éœ€ç¢ºèªæ•¸';
    action: 'æ›´æ–°è¨‚å–®ç‹€æ…‹ã€ç™¼é€é€šçŸ¥';
    data: 'äº¤æ˜“å“ˆå¸Œã€ç¢ºèªæ™‚é–“ã€å€å¡Šè™Ÿ';
    nextState: 'order_processing';
  };
  
  // 4. æ”¯ä»˜éæœŸ
  paymentExpired: {
    trigger: 'è¶…éæ”¯ä»˜éæœŸæ™‚é–“';
    action: 'å–æ¶ˆè¨‚å–®ã€é‡‹æ”¾åº«å­˜';
    data: 'éæœŸæ™‚é–“ã€å–æ¶ˆåŸå› ';
    nextState: 'order_cancelled';
  };
}

// æ”¯ä»˜é©—è­‰é‚è¼¯
interface PaymentValidation {
  // äº¤æ˜“é©—è­‰
  transactionValidation: {
    // æª¢æŸ¥äº¤æ˜“å“ˆå¸Œ
    verifyTransactionHash: (txHash: string) => boolean;
    
    // æª¢æŸ¥ç¢ºèªæ•¸
    verifyConfirmations: (confirmations: number, required: number) => boolean;
    
    // æª¢æŸ¥é‡‘é¡
    verifyAmount: (expected: number, actual: number, tolerance: number) => boolean;
    
    // æª¢æŸ¥æ”¶æ¬¾åœ°å€
    verifyRecipientAddress: (expected: string, actual: string) => boolean;
    
    // æª¢æŸ¥ç™¼é€åœ°å€
    verifySenderAddress: (sender: string, whitelist: string[]) => boolean;
  };
  
  // å®‰å…¨æª¢æŸ¥
  securityChecks: {
    // é˜²é‡æ”¾æ”»æ“Š
    preventReplayAttack: (txHash: string, orderId: string) => boolean;
    
    // é˜²é›™é‡æ”¯ä»˜
    preventDoubleSpending: (orderId: string) => boolean;
    
    // é˜²é‡‘é¡æ“ç¸±
    preventAmountManipulation: (order: PaymentOrder) => boolean;
    
    // é˜²åœ°å€å½é€ 
    preventAddressSpoofing: (address: string) => boolean;
  };
}
```

### **4. åŒ¯ç‡ç®¡ç†ç³»çµ±**
```typescript
// åŒ¯ç‡ç®¡ç†
interface ExchangeRateManagement {
  // åŒ¯ç‡ä¾†æº
  rateSources: {
    primary: 'Chainlink Price Feeds';     // ä¸»è¦ä¾†æº
    secondary: 'CoinGecko API';           // å‚™ç”¨ä¾†æº
    tertiary: 'Binance API';              // ç¬¬ä¸‰ä¾†æº
  };
  
  // åŒ¯ç‡æ›´æ–°é »ç‡
  updateFrequency: {
    usdt: 'æ¯ 1 åˆ†é˜æ›´æ–°';
    major: 'æ¯ 5 åˆ†é˜æ›´æ–°';
    minor: 'æ¯ 15 åˆ†é˜æ›´æ–°';
  };
  
  // åŒ¯ç‡è¨ˆç®—
  rateCalculation: {
    // å³æ™‚åŒ¯ç‡
    getCurrentRate: (from: string, to: string) => number;
    
    // æ­·å²åŒ¯ç‡
    getHistoricalRate: (from: string, to: string, date: Date) => number;
    
    // åŒ¯ç‡è®ŠåŒ–
    getRateChange: (from: string, to: string, period: string) => number;
    
    // åŒ¯ç‡é è­¦
    setRateAlert: (from: string, to: string, threshold: number) => void;
  };
  
  // åŒ¯ç‡ç·©å­˜
  rateCaching: {
    cacheStrategy: 'Redis + Memory';
    ttl: '1 åˆ†é˜';
    fallback: 'ä½¿ç”¨æœ€å¾Œå·²çŸ¥åŒ¯ç‡';
  };
}
```

### **5. æ”¯ä»˜ API è¨­è¨ˆ**
```typescript
// æ”¯ä»˜ç³»çµ± API ç«¯é»
const paymentApiEndpoints = {
  // æ”¯ä»˜ç®¡ç† API
  payments: {
    GET: '/api/payments',                    // ç²å–æ”¯ä»˜åˆ—è¡¨
    POST: '/api/payments/create',            // å‰µå»ºæ”¯ä»˜
    GET: '/api/payments/:id',                // ç²å–æ”¯ä»˜è©³æƒ…
    PUT: '/api/payments/:id/status',         // æ›´æ–°æ”¯ä»˜ç‹€æ…‹
    POST: '/api/payments/:id/refund',        // é€€æ¬¾
    GET: '/api/payments/:id/qr',             // ç²å–æ”¯ä»˜ QR ç¢¼
  },
  
  // éŒ¢åŒ…ç®¡ç† API
  wallets: {
    GET: '/api/wallets',                     // ç²å–éŒ¢åŒ…åˆ—è¡¨
    POST: '/api/wallets/create',             // å‰µå»ºéŒ¢åŒ…
    GET: '/api/wallets/:id',                 // ç²å–éŒ¢åŒ…è©³æƒ…
    PUT: '/api/wallets/:id',                 // æ›´æ–°éŒ¢åŒ…
    GET: '/api/wallets/:id/balance',         // ç²å–éŒ¢åŒ…é¤˜é¡
    POST: '/api/wallets/:id/sync',           // åŒæ­¥éŒ¢åŒ…
  },
  
  // åŒ¯ç‡ç®¡ç† API
  exchangeRates: {
    GET: '/api/exchange-rates/current',      // ç²å–ç•¶å‰åŒ¯ç‡
    GET: '/api/exchange-rates/history',      // ç²å–æ­·å²åŒ¯ç‡
    GET: '/api/exchange-rates/currencies',   // ç²å–æ”¯æŒå¹£ç¨®
    POST: '/api/exchange-rates/convert',     // åŒ¯ç‡è½‰æ›
  },
  
  // å€å¡Šéˆäº¤æ˜“ API
  blockchain: {
    GET: '/api/blockchain/transaction/:hash', // ç²å–äº¤æ˜“è©³æƒ…
    GET: '/api/blockchain/address/:address',  // ç²å–åœ°å€è©³æƒ…
    GET: '/api/blockchain/confirmations/:hash', // ç²å–ç¢ºèªæ•¸
    POST: '/api/blockchain/webhook',          // å€å¡Šéˆäº‹ä»¶ webhook
  }
};

// æ”¯ä»˜ç³»çµ±éŸ¿æ‡‰æ ¼å¼
interface PaymentApiResponse<T> {
  success: boolean;
  data?: T;
  message?: string;
  error?: string;
  timestamp: string;
  requestId: string;
  paymentId?: string;                        // æ”¯ä»˜ ID
  transactionHash?: string;                  // äº¤æ˜“å“ˆå¸Œ
  confirmations?: number;                    // ç¢ºèªæ•¸
  exchangeRate?: number;                     // åŒ¯ç‡
}
```

### **6. æ”¯ä»˜ç³»çµ±é›†æˆ**
```typescript
// èˆ‡ç¾æœ‰ç³»çµ±çš„é›†æˆ
interface PaymentSystemIntegration {
  // Telegram Bot é›†æˆ
  telegramBot: {
    paymentCommands: [
      '/pay_order',           // æ”¯ä»˜è¨‚å–®
      '/payment_status',      // æŸ¥çœ‹æ”¯ä»˜ç‹€æ…‹
      '/wallet_balance',      // æŸ¥çœ‹éŒ¢åŒ…é¤˜é¡
      '/payment_history',     // æŸ¥çœ‹æ”¯ä»˜æ­·å²
      '/refund_request'       // ç”³è«‹é€€æ¬¾
    ];
    paymentNotifications: [
      'payment_created',      // æ”¯ä»˜å‰µå»ºé€šçŸ¥
      'payment_confirmed',    // æ”¯ä»˜ç¢ºèªé€šçŸ¥
      'payment_failed',       // æ”¯ä»˜å¤±æ•—é€šçŸ¥
      'payment_expired',      // æ”¯ä»˜éæœŸé€šçŸ¥
      'refund_processed'      // é€€æ¬¾è™•ç†é€šçŸ¥
    ];
  };
  
  // MiniWeb é›†æˆ
  miniWeb: {
    paymentInterface: 'æ”¯ä»˜é é¢';
    walletConnection: 'éŒ¢åŒ…é€£æ¥';
    paymentHistory: 'æ”¯ä»˜è¨˜éŒ„';
    refundRequest: 'é€€æ¬¾ç”³è«‹';
  };
  
  // ç®¡ç†å¾Œå°é›†æˆ
  adminDashboard: {
    paymentOverview: 'æ”¯ä»˜æ¦‚è¦½å„€è¡¨æ¿';
    transactionMonitoring: 'äº¤æ˜“ç›£æ§';
    refundManagement: 'é€€æ¬¾ç®¡ç†';
    walletManagement: 'éŒ¢åŒ…ç®¡ç†';
  };
  
  // ä»£ç†ç³»çµ±é›†æˆ
  agentSystem: {
    commissionPayment: 'ä½£é‡‘æ”¯ä»˜';
    agentWallet: 'ä»£ç†éŒ¢åŒ…';
    paymentTracking: 'æ”¯ä»˜è¿½è¹¤';
  };
}
```

### **7. å®‰å…¨èˆ‡åˆè¦**
```typescript
// æ”¯ä»˜å®‰å…¨é…ç½®
interface PaymentSecurity {
  // åŠ å¯†é…ç½®
  encryption: {
    algorithm: 'AES-256-GCM';
    keyLength: 32;
    ivLength: 16;
    saltLength: 64;
  };
  
  // èº«ä»½é©—è­‰
  authentication: {
    method: 'Telegram-based + Wallet Signature';
    mfa: 'Optional 2FA for large amounts';
    sessionTimeout: '30 minutes';
  };
  
  // é¢¨éšªæ§åˆ¶
  riskControl: {
    // å–®ç­†é™é¡
    singleLimit: {
      min: 1;                    // æœ€å° 1 USDT
      max: 10000;                // æœ€å¤§ 10,000 USDT
    };
    
    // æ—¥ç´¯è¨ˆé™é¡
    dailyLimit: {
      min: 1;                    // æœ€å° 1 USDT
      max: 50000;                // æœ€å¤§ 50,000 USDT
    };
    
    // å¯ç–‘äº¤æ˜“æª¢æ¸¬
    suspiciousDetection: [
      'ç•°å¸¸å¤§é¡äº¤æ˜“',
      'é »ç¹å°é¡äº¤æ˜“',
      'å¯ç–‘åœ°å€æ¨¡å¼',
      'ç•°å¸¸æ™‚é–“æ¨¡å¼'
    ];
  };
  
  // åˆè¦è¦æ±‚
  compliance: {
    kyc: 'Optional for small amounts';
    aml: 'Automated monitoring';
    reporting: 'Monthly compliance reports';
    audit: 'Annual security audit';
  };
}
```

---

## ğŸ¢ **ä»£ç†ç³»çµ±æ¶æ§‹ (Agent System Architecture)**

### **1. ä»£ç†ç³»çµ±æ ¸å¿ƒæ¶æ§‹**
```typescript
// ä»£ç†ç³»çµ±æ•¸æ“šçµæ§‹
interface AgentSystem {
  // ä»£ç†å±¤ç´šçµæ§‹
  agentLevels: {
    level1: 'ä¸€ç´šä»£ç† (ç›´æ¥ä»£ç†)';
    level2: 'äºŒç´šä»£ç† (é–“æ¥ä»£ç†)';
    level3: 'ä¸‰ç´šä»£ç† (é–“æ¥é–“æ¥ä»£ç†)';
    maxLevels: 3; // æœ€å¤§ä»£ç†å±¤ç´š
  };
  
  // ä»£ç†é¡å‹
  agentTypes: {
    individual: 'å€‹äººä»£ç†';
    company: 'ä¼æ¥­ä»£ç†';
    store: 'å¯¦é«”åº—ä»£ç†';
    online: 'ç¶²åº—ä»£ç†';
  };
  
  // ä»£ç†ç‹€æ…‹
  agentStatus: {
    pending: 'å¾…å¯©æ ¸';
    active: 'æ´»èº';
    suspended: 'æš«åœ';
    terminated: 'çµ‚æ­¢';
  };
}

// ä»£ç†ç”¨æˆ¶æ•¸æ“šçµæ§‹
interface AgentUser {
  id: string;
  telegramId: number;                    // Telegram ç”¨æˆ¶ ID
  agentCode: string;                     // ä»£ç†ç·¨ç¢¼ (å”¯ä¸€)
  agentLevel: 1 | 2 | 3;                // ä»£ç†å±¤ç´š
  parentAgentId?: string;                // ä¸Šç´šä»£ç† ID
  childAgents: string[];                 // ä¸‹ç´šä»£ç† ID åˆ—è¡¨
  commissionRate: number;                // ä½£é‡‘æ¯”ä¾‹ (%)
  totalSales: number;                    // ç¸½éŠ·å”®é¡
  totalCommission: number;               // ç¸½ä½£é‡‘
  monthlyTarget: number;                 // æœˆåº¦ç›®æ¨™
  monthlyAchievement: number;            // æœˆåº¦é”æˆ
  status: 'pending' | 'active' | 'suspended' | 'terminated';
  joinDate: Timestamp;                   // åŠ å…¥æ—¥æœŸ
  lastActivity: Timestamp;               // æœ€å¾Œæ´»å‹•
  createdAt: Timestamp;
  updatedAt: Timestamp;
}

// ä»£ç†è¨‚å–®æ•¸æ“šçµæ§‹
interface AgentOrder {
  id: string;
  orderId: string;                       // åŸå§‹è¨‚å–® ID
  agentId: string;                       // ä»£ç† ID
  customerId: string;                    // å®¢æˆ¶ ID
  products: OrderProduct[];              // å•†å“åˆ—è¡¨
  subtotal: number;                      // è¨‚å–®å°è¨ˆ
  commission: number;                    // ä»£ç†ä½£é‡‘
  commissionRate: number;                // ä½£é‡‘æ¯”ä¾‹
  orderStatus: 'pending' | 'processing' | 'shipped' | 'delivered' | 'cancelled';
  commissionStatus: 'pending' | 'paid' | 'cancelled'; // ä½£é‡‘ç‹€æ…‹
  commissionPaidAt?: Timestamp;          // ä½£é‡‘æ”¯ä»˜æ™‚é–“
  createdAt: Timestamp;
  updatedAt: Timestamp;
}
```

### **2. ä½£é‡‘è¨ˆç®—ç³»çµ±**
```typescript
// ä½£é‡‘è¨ˆç®—å¼•æ“
class CommissionCalculator {
  // åŸºç¤ä½£é‡‘è¨ˆç®—
  calculateCommission(order: AgentOrder, agent: AgentUser): number {
    const baseCommission = order.subtotal * (agent.commissionRate / 100);
    
    // å±¤ç´šçå‹µ
    const levelBonus = this.calculateLevelBonus(agent.agentLevel);
    
    // æ¥­ç¸¾çå‹µ
    const performanceBonus = this.calculatePerformanceBonus(agent);
    
    // ç‰¹æ®Šæ´»å‹•çå‹µ
    const campaignBonus = this.calculateCampaignBonus(order);
    
    return baseCommission + levelBonus + performanceBonus + campaignBonus;
  }
  
  // å±¤ç´šçå‹µè¨ˆç®—
  private calculateLevelBonus(level: number): number {
    const levelMultipliers = { 1: 1.0, 2: 0.8, 3: 0.6 };
    return levelMultipliers[level] || 0;
  }
  
  // æ¥­ç¸¾çå‹µè¨ˆç®—
  private calculatePerformanceBonus(agent: AgentUser): number {
    const achievementRate = agent.monthlyAchievement / agent.monthlyTarget;
    
    if (achievementRate >= 1.5) return 0.1;      // è¶…é¡å®Œæˆ 150%
    if (achievementRate >= 1.2) return 0.05;     // è¶…é¡å®Œæˆ 120%
    if (achievementRate >= 1.0) return 0.02;     // å®Œæˆç›®æ¨™
    return 0;
  }
  
  // æ´»å‹•çå‹µè¨ˆç®—
  private calculateCampaignBonus(order: AgentOrder): number {
    // æ ¹æ“šä¿ƒéŠ·æ´»å‹•è¨ˆç®—é¡å¤–çå‹µ
    return 0; // é è¨­å€¼
  }
}

// ä½£é‡‘åˆ†é…ç­–ç•¥
interface CommissionStrategy {
  // ç›´æ¥éŠ·å”®ä½£é‡‘
  directSale: {
    level1: 0.15,  // 15%
    level2: 0.08,  // 8%
    level3: 0.05   // 5%
  };
  
  // åœ˜éšŠéŠ·å”®ä½£é‡‘
  teamSale: {
    level1: 0.05,  // 5%
    level2: 0.03,  // 3%
    level3: 0.02   // 2%
  };
  
  // æ–°ä»£ç†æ¨è–¦çå‹µ
  referralBonus: {
    level1: 50,    // 50 å…ƒ
    level2: 30,    // 30 å…ƒ
    level3: 20     // 20 å…ƒ
  };
}
```

### **3. ä»£ç†ç®¡ç†åŠŸèƒ½**
```typescript
// ä»£ç†ç®¡ç†æ¨¡çµ„
interface AgentManagement {
  // ä»£ç†è¨»å†Šèˆ‡å¯©æ ¸
  registration: {
    apply: 'æäº¤ä»£ç†ç”³è«‹';
    review: 'ç®¡ç†å“¡å¯©æ ¸';
    approve: 'æ‰¹å‡†ä»£ç†è³‡æ ¼';
    reject: 'æ‹’çµ•ä»£ç†ç”³è«‹';
    activate: 'æ¿€æ´»ä»£ç†å¸³æˆ¶';
  };
  
  // ä»£ç†ç­‰ç´šç®¡ç†
  levelManagement: {
    upgrade: 'å‡ç´šä»£ç†ç­‰ç´š';
    downgrade: 'é™ç´šä»£ç†ç­‰ç´š';
    transfer: 'è½‰ç§»ä»£ç†é—œä¿‚';
    merge: 'åˆä½µä»£ç†å¸³æˆ¶';
  };
  
  // ä½£é‡‘ç®¡ç†
  commissionManagement: {
    calculate: 'è¨ˆç®—ä½£é‡‘';
    distribute: 'åˆ†é…ä½£é‡‘';
    payout: 'ä½£é‡‘æ”¯ä»˜';
    adjust: 'ä½£é‡‘èª¿æ•´';
    refund: 'ä½£é‡‘é€€æ¬¾';
  };
  
  // æ¥­ç¸¾è¿½è¹¤
  performanceTracking: {
    sales: 'éŠ·å”®æ¥­ç¸¾';
    commission: 'ä½£é‡‘æ”¶å…¥';
    team: 'åœ˜éšŠæ¥­ç¸¾';
    ranking: 'æ¥­ç¸¾æ’å';
    reports: 'æ¥­ç¸¾å ±è¡¨';
  };
}

// ä»£ç†æ¿€å‹µæ©Ÿåˆ¶
interface AgentIncentives {
  // æœˆåº¦çå‹µ
  monthlyRewards: {
    topSales: 'éŠ·å”®å† è»çå‹µ';
    topCommission: 'ä½£é‡‘å† è»çå‹µ';
    growthChampion: 'æˆé•·å† è»çå‹µ';
    teamBuilder: 'åœ˜éšŠå»ºè¨­çå‹µ';
  };
  
  // å­£åº¦çå‹µ
  quarterlyRewards: {
    performanceBonus: 'å­£åº¦ç¸¾æ•ˆçé‡‘';
    travelReward: 'æ—…éŠçå‹µ';
    trainingReward: 'åŸ¹è¨“çå‹µ';
  };
  
  // å¹´åº¦çå‹µ
  yearlyRewards: {
    annualBonus: 'å¹´åº¦çé‡‘';
    luxuryReward: 'å¥¢ä¾ˆå“çå‹µ';
    partnership: 'åˆå¤¥äººè³‡æ ¼';
  };
}
```

### **4. ä»£ç†ç³»çµ± API è¨­è¨ˆ**
```typescript
// ä»£ç†ç³»çµ± API ç«¯é»
const agentApiEndpoints = {
  // ä»£ç†ç®¡ç† API
  agents: {
    GET: '/api/agents',                    // ç²å–ä»£ç†åˆ—è¡¨
    POST: '/api/agents',                   // å‰µå»ºä»£ç†
    PUT: '/api/agents/:id',                // æ›´æ–°ä»£ç†
    DELETE: '/api/agents/:id',             // åˆªé™¤ä»£ç†
    PATCH: '/api/agents/:id/status',       // æ›´æ–°ä»£ç†ç‹€æ…‹
  },
  
  // ä½£é‡‘ç®¡ç† API
  commissions: {
    GET: '/api/commissions',               // ç²å–ä½£é‡‘åˆ—è¡¨
    POST: '/api/commissions/calculate',    // è¨ˆç®—ä½£é‡‘
    PUT: '/api/commissions/:id/payout',    // æ”¯ä»˜ä½£é‡‘
    GET: '/api/commissions/summary',       // ä½£é‡‘æ‘˜è¦
  },
  
  // æ¥­ç¸¾è¿½è¹¤ API
  performance: {
    GET: '/api/performance/sales',         // éŠ·å”®æ¥­ç¸¾
    GET: '/api/performance/commission',    // ä½£é‡‘æ¥­ç¸¾
    GET: '/api/performance/team',          // åœ˜éšŠæ¥­ç¸¾
    GET: '/api/performance/ranking',       // æ¥­ç¸¾æ’å
  },
  
  // ä»£ç†æ¿€å‹µ API
  incentives: {
    GET: '/api/incentives/available',      // å¯ç”¨çå‹µ
    POST: '/api/incentives/claim',         // é ˜å–çå‹µ
    GET: '/api/incentives/history',        // çå‹µæ­·å²
  }
};

// ä»£ç†ç³»çµ±éŸ¿æ‡‰æ ¼å¼
interface AgentApiResponse<T> {
  success: boolean;
  data?: T;
  message?: string;
  error?: string;
  timestamp: string;
  requestId: string;
  agentId?: string;                        // ä»£ç† ID
  commission?: number;                      // ç›¸é—œä½£é‡‘
}
```

### **5. ä»£ç†ç³»çµ±é›†æˆ**
```typescript
// èˆ‡ç¾æœ‰ç³»çµ±çš„é›†æˆ
interface SystemIntegration {
  // Telegram Bot é›†æˆ
  telegramBot: {
    agentCommands: [
      '/agent_status',      // æŸ¥çœ‹ä»£ç†ç‹€æ…‹
      '/agent_earnings',    // æŸ¥çœ‹æ”¶ç›Š
      '/agent_team',        // æŸ¥çœ‹åœ˜éšŠ
      '/agent_orders',      // æŸ¥çœ‹è¨‚å–®
      '/agent_commission'   // æŸ¥çœ‹ä½£é‡‘
    ];
    agentNotifications: [
      'new_order',          // æ–°è¨‚å–®é€šçŸ¥
      'commission_paid',    // ä½£é‡‘æ”¯ä»˜é€šçŸ¥
      'level_upgrade',      // ç­‰ç´šå‡ç´šé€šçŸ¥
      'target_achieved'     // ç›®æ¨™é”æˆé€šçŸ¥
    ];
  };
  
  // MiniWeb é›†æˆ
  miniWeb: {
    agentDashboard: 'ä»£ç†å°ˆç”¨å„€è¡¨æ¿';
    orderTracking: 'è¨‚å–®è¿½è¹¤ç³»çµ±';
    commissionHistory: 'ä½£é‡‘æ­·å²è¨˜éŒ„';
    teamManagement: 'åœ˜éšŠç®¡ç†ç•Œé¢';
  };
  
  // ç®¡ç†å¾Œå°é›†æˆ
  adminDashboard: {
    agentOverview: 'ä»£ç†æ¦‚è¦½å„€è¡¨æ¿';
    commissionManagement: 'ä½£é‡‘ç®¡ç†ç•Œé¢';
    performanceAnalytics: 'æ¥­ç¸¾åˆ†æå·¥å…·';
    incentiveManagement: 'æ¿€å‹µæ©Ÿåˆ¶ç®¡ç†';
  };
}
```

---

## ğŸŒ **ç’°å¢ƒé…ç½®èˆ‡éƒ¨ç½²æŒ‡å— (Environment Configuration & Deployment Guide)**

### **ğŸ“‹ ç’°å¢ƒé…ç½®æ–‡ä»¶**
æœ¬é …ç›®åŒ…å«å®Œæ•´çš„ç’°å¢ƒé…ç½®ç¯„ä¾‹å’Œèªªæ˜æ–‡æª”ï¼š

#### **1. ç’°å¢ƒè®Šæ•¸ç¯„ä¾‹æ–‡ä»¶**
- **æ–‡ä»¶è·¯å¾‘**: `env.example`
- **ç”¨é€”**: åŒ…å«æ‰€æœ‰å¿…è¦çš„ç’°å¢ƒè®Šæ•¸é…ç½®
- **ä½¿ç”¨æ–¹æ³•**: è¤‡è£½ç‚º `.env` ä¸¦å¡«å…¥å¯¦éš›å€¼

#### **2. ç’°å¢ƒé…ç½®èªªæ˜æ–‡æª”**
- **æ–‡ä»¶è·¯å¾‘**: `ENVIRONMENT_SETUP.md`
- **å…§å®¹**: è©³ç´°çš„é…ç½®èªªæ˜ã€æ•…éšœæ’é™¤å’Œæœ€ä½³å¯¦è¸

### **ğŸš€ å¿«é€Ÿé…ç½®æ­¥é©Ÿ**

#### **æ­¥é©Ÿ 1: è¤‡è£½ç’°å¢ƒé…ç½®**
```bash
cd /home/a0928997578_gmail_com/å‰å¤§
cp env.example .env
```

#### **æ­¥é©Ÿ 2: ç·¨è¼¯é…ç½®æ–‡ä»¶**
æ ¹æ“šå¯¦éš›æƒ…æ³ç·¨è¼¯ `.env` æ–‡ä»¶ä¸­çš„é…ç½®å€¼ã€‚

#### **æ­¥é©Ÿ 3: é‡å•Ÿæœå‹™**
é…ç½®å®Œæˆå¾Œé‡å•Ÿç›¸é—œæœå‹™ä½¿é…ç½®ç”Ÿæ•ˆã€‚

### **ğŸ”‘ æ ¸å¿ƒé…ç½®é …**

#### **Firebase é…ç½® (å¿…éœ€)**
```bash
FIREBASE_PROJECT_ID=your-project-id
FIREBASE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\nYour Private Key Here\n-----END PRIVATE KEY-----\n"
FIREBASE_CLIENT_EMAIL=firebase-adminsdk-xxxxx@your-project-id.iam.gserviceaccount.com
```

#### **Telegram Bot é…ç½® (å¿…éœ€)**
```bash
TELEGRAM_BOT_TOKEN=your-telegram-bot-token
TELEGRAM_WEBHOOK_SECRET=your-webhook-secret
TELEGRAM_WEBHOOK_URL=https://your-project-id.cloudfunctions.net/telegramWebhook
```

#### **æ”¯ä»˜ç³»çµ±é…ç½® (å¿…éœ€)**
```bash
TRON_WALLET_ADDRESS=TYourTronWalletAddressHere
ETHEREUM_WALLET_ADDRESS=0xYourEthereumWalletAddressHere
SYSTEM_WALLET_ADDRESS=TYourSystemWalletAddressHere
```

#### **å®‰å…¨é…ç½® (å¿…éœ€)**
```bash
JWT_SECRET=your-jwt-secret-key-here
JWT_EXPIRES_IN=24h
ALLOWED_ORIGINS=https://your-domain.com
```

### **ğŸ“š é…ç½®æ–‡æª”çµæ§‹**

```
å‰å¤§/
â”œâ”€â”€ env.example              # ç’°å¢ƒè®Šæ•¸ç¯„ä¾‹
â”œâ”€â”€ ENVIRONMENT_SETUP.md     # ç’°å¢ƒé…ç½®èªªæ˜
â”œâ”€â”€ WORK_PROGRESS.md         # å·¥ä½œé€²åº¦å ±å‘Š
â”œâ”€â”€ ARCHITECTURE_BLUEPRINT.md # ç³»çµ±æ¶æ§‹è—åœ–
â””â”€â”€ functions/               # å¾Œç«¯ä»£ç¢¼
    â”œâ”€â”€ src/
    â”‚   â”œâ”€â”€ services/        # æœå‹™å±¤
    â”‚   â”œâ”€â”€ types/           # é¡å‹å®šç¾©
    â”‚   â””â”€â”€ routes/          # API è·¯ç”±
    â””â”€â”€ package.json         # ä¾è³´é…ç½®
```

### **ğŸ”§ é–‹ç™¼ç’°å¢ƒè¨­ç½®**

#### **1. å®‰è£ä¾è³´**
```bash
cd functions
npm install
```

#### **2. ç·¨è­¯ TypeScript**
```bash
npm run build
```

#### **3. æœ¬åœ°æ¸¬è©¦**
```bash
npm run dev
```

#### **4. éƒ¨ç½²åˆ° Firebase**
```bash
firebase deploy --only functions
```

### **ğŸ“± Telegram Bot è¨­ç½®**

#### **1. å‰µå»º Bot**
1. åœ¨ Telegram ä¸­æœç´¢ `@BotFather`
2. ç™¼é€ `/newbot` å‘½ä»¤
3. è¨­ç½® Bot åç¨±å’Œç”¨æˆ¶å
4. ç²å– Bot Token

#### **2. è¨­ç½® Webhook**
```bash
curl -F "url=https://your-project-id.cloudfunctions.net/telegramWebhook" \
     https://api.telegram.org/bot<BOT_TOKEN>/setWebhook
```

### **ğŸ’° æ”¯ä»˜ç³»çµ±é…ç½®**

#### **1. USDT-TRC20 é…ç½®**
- ç²å– Tron éŒ¢åŒ…åœ°å€
- é…ç½® Tron API å¯†é‘°
- è¨­ç½®ç¢ºèªæ•¸ (å»ºè­° 20)

#### **2. åŒ¯ç‡ API é…ç½®**
- CoinGecko API (å…è²»ï¼Œæ¨è–¦)
- Binance API (å‚™ç”¨)

### **ğŸ”’ å®‰å…¨æ³¨æ„äº‹é …**

#### **1. ç’°å¢ƒè®Šæ•¸ä¿è­·**
- æ°¸é ä¸è¦å°‡ `.env` æ–‡ä»¶æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶
- ä½¿ç”¨å¼·å¯†é‘°å’Œå¯†ç¢¼
- å®šæœŸæ›´æ› API å¯†é‘°

#### **2. æ¬Šé™ç®¡ç†**
- é™åˆ¶ API å¯†é‘°çš„æ¬Šé™ç¯„åœ
- ä½¿ç”¨å°ˆç”¨çš„æœå‹™å¸³æˆ¶
- å•Ÿç”¨å®‰å…¨æ—¥èªŒè¨˜éŒ„

### **ğŸ“Š ç›£æ§å’Œç¶­è­·**

#### **1. æ€§èƒ½ç›£æ§**
```bash
ENABLE_PERFORMANCE_MONITORING=true
ENABLE_ERROR_TRACKING=true
ENABLE_ANALYTICS=true
```

#### **2. æ—¥èªŒé…ç½®**
```bash
LOG_LEVEL=info
LOG_FILE_PATH=./logs/app.log
```

#### **3. å‚™ä»½é…ç½®**
```bash
ENABLE_AUTO_BACKUP=true
BACKUP_FREQUENCY_HOURS=24
BACKUP_RETENTION_DAYS=30
```

### **ğŸš¨ æ•…éšœæ’é™¤**

#### **å¸¸è¦‹å•é¡Œè§£æ±º**

1. **Firebase é€£æ¥å¤±æ•—**
   - æª¢æŸ¥é …ç›® ID å’Œæœå‹™å¸³æˆ¶æ¬Šé™
   - ç¢ºèªç¶²çµ¡é€£æ¥

2. **Telegram Bot ç„¡éŸ¿æ‡‰**
   - æª¢æŸ¥ Bot Token å’Œ Webhook è¨­ç½®
   - ç¢ºèªå‡½æ•¸éƒ¨ç½²ç‹€æ…‹

3. **æ”¯ä»˜ç³»çµ±éŒ¯èª¤**
   - æª¢æŸ¥éŒ¢åŒ…åœ°å€æ ¼å¼
   - ç¢ºèªç¶²çµ¡é…ç½®å’Œ API å¯†é‘°

4. **ç’°å¢ƒè®Šæ•¸æœªç”Ÿæ•ˆ**
   - é‡å•Ÿç›¸é—œæœå‹™
   - æª¢æŸ¥è®Šæ•¸åç¨±æ‹¼å¯«

### **ğŸ“ æŠ€è¡“æ”¯æŒ**

#### **æ–‡æª”è³‡æº**
- [Firebase æ–‡æª”](https://firebase.google.com/docs)
- [Telegram Bot API](https://core.telegram.org/bots/api)
- [Tron é–‹ç™¼æ–‡æª”](https://developers.tron.network/)
- [Ethereum é–‹ç™¼æ–‡æª”](https://ethereum.org/developers/)

#### **é …ç›®æ–‡æª”**
- `ENVIRONMENT_SETUP.md` - è©³ç´°é…ç½®èªªæ˜
- `WORK_PROGRESS.md` - é–‹ç™¼é€²åº¦å’Œç‹€æ…‹
- `ARCHITECTURE_BLUEPRINT.md` - ç³»çµ±æ¶æ§‹è¨­è¨ˆ

---

## ğŸ¯ **é–‹ç™¼è·¯ç·šåœ– (Development Roadmap)**

### **ç¬¬ä¸€éšæ®µï¼šåŸºç¤æ¶æ§‹** ğŸ—ï¸ âœ…
- [x] Firebase é …ç›®è¨­ç½®
- [x] æ•¸æ“šåº«è¨­è¨ˆå’Œçµæ§‹ (åŸºæ–¼ Telegram ç”¨æˆ¶)
- [x] åŸºç¤ API æ¶æ§‹
- [x] Telegram ç”¨æˆ¶èªè­‰ç³»çµ±

### **ç¬¬äºŒéšæ®µï¼šTelegram Bot** ğŸ¤– âœ…
- [x] Bot åŸºç¤åŠŸèƒ½
- [x] å•†å“æŸ¥è©¢åŠŸèƒ½
- [x] è³¼ç‰©è»Šç®¡ç†
- [x] è¨‚å–®è™•ç†
- [x] æ”¯ä»˜é›†æˆæ¸¬è©¦
- [x] Bot å‘½ä»¤æ“´å±•

### **ç¬¬ä¸‰éšæ®µï¼šMiniWeb** ğŸŒ
- [ ] PWA åŸºç¤è¨­ç½®
- [ ] éŸ¿æ‡‰å¼è¨­è¨ˆ
- [ ] æ ¸å¿ƒè³¼ç‰©åŠŸèƒ½
- [ ] é›¢ç·šæ”¯æŒ

### **ç¬¬å››éšæ®µï¼šç®¡ç†å¾Œå°** ğŸ–¥ï¸
- [ ] Next.js æ‡‰ç”¨æ¡†æ¶
- [ ] ç®¡ç†å„€è¡¨æ¿
- [ ] æ•¸æ“šå¯è¦–åŒ–
- [ ] å®Œæ•´ç®¡ç†åŠŸèƒ½

### **ç¬¬äº”éšæ®µï¼šä»£ç†ç³»çµ±** ğŸ¢
- [ ] ä»£ç†è¨»å†Šèˆ‡å¯©æ ¸ç³»çµ±
- [ ] ä½£é‡‘è¨ˆç®—å¼•æ“
- [ ] ä»£ç†ç®¡ç†ç•Œé¢
- [ ] æ¥­ç¸¾è¿½è¹¤ç³»çµ±

### **ç¬¬å…­éšæ®µï¼šæ”¯ä»˜ç³»çµ±** ğŸ’°
- [ ] USDT-TRC20 æ”¯ä»˜ç¶²é—œ
- [ ] æ™ºèƒ½åˆç´„éƒ¨ç½²
- [ ] éŒ¢åŒ…ç®¡ç†ç³»çµ±
- [ ] åŒ¯ç‡ç®¡ç†ç³»çµ±
- [ ] æ”¯ä»˜å®‰å…¨é©—è­‰

### **ç¬¬ä¸ƒéšæ®µï¼šæ•´åˆæ¸¬è©¦** ğŸ§ª
- [ ] å¤šå¹³å°æ•¸æ“šåŒæ­¥
- [ ] ç«¯åˆ°ç«¯æ¸¬è©¦
- [ ] æ€§èƒ½å„ªåŒ–
- [ ] å®‰å…¨æ¸¬è©¦
- [ ] æ”¯ä»˜æµç¨‹æ¸¬è©¦

---

**æ¶æ§‹ç‹€æ…‹**: ç¬¬äºŒéšæ®µå®Œæˆï¼ŒåŒ…å«å®Œæ•´çš„ Telegram Bot åŠŸèƒ½ ğŸš€  
**æœ€å¾Œæ›´æ–°**: 2025-08-26  
**ç‰ˆæœ¬**: 2.2.0 - å¤šå¹³å°ç‰ˆæœ¬ + ä»£ç†ç³»çµ± + USDT-TRC20 æ”¯ä»˜ + ç’°å¢ƒé…ç½®æŒ‡å—  

é€™ä»½æ›´æ–°çš„æ¶æ§‹è—åœ–æä¾›äº†å®Œæ•´çš„å¤šå¹³å°é›»å•†ç³»çµ±è¨­è¨ˆï¼ŒåŒ…æ‹¬ Telegram Botã€MiniWeb å’Œç¶²ç«™ç®¡ç†å¾Œå°ã€‚ç³»çµ±æ¡ç”¨ç¾ä»£åŒ–çš„æŠ€è¡“æ£§ï¼Œå…·æœ‰è‰¯å¥½çš„å¯æ“´å±•æ€§ã€å®‰å…¨æ€§å’Œç¶­è­·æ€§ã€‚æ¯å€‹å¹³å°éƒ½æœ‰æ˜ç¢ºçš„åŠŸèƒ½å®šä½å’ŒæŠ€è¡“å¯¦ç¾æ–¹æ¡ˆï¼Œç¢ºä¿ç”¨æˆ¶åœ¨ä¸åŒå ´æ™¯ä¸‹éƒ½èƒ½ç²å¾—æœ€ä½³çš„è³¼ç‰©é«”é©—ã€‚

**ç’°å¢ƒé…ç½®å·²å®Œæˆï¼Œä¸‹ä¸€ä½é–‹ç™¼è€…å¯ä»¥ç›´æ¥ä½¿ç”¨ `env.example` å’Œ `ENVIRONMENT_SETUP.md` é€²è¡Œç³»çµ±é…ç½®å’Œéƒ¨ç½²ã€‚**
