#!/bin/bash

# ğŸ” ShopBot å®‰å…¨æª¢æŸ¥å·¥å…·
# ä½¿ç”¨æ–¹æ³•: shopbot-security [é¸é …]

# ç²å–è…³æœ¬æ‰€åœ¨ç›®éŒ„
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# é¡¯ç¤ºå¹«åŠ©ä¿¡æ¯
show_help() {
    echo "ğŸ” ShopBot å®‰å…¨æª¢æŸ¥å·¥å…·"
    echo "================================"
    echo ""
    echo "ä½¿ç”¨æ–¹æ³•:"
    echo "  $0 [é¸é …]"
    echo ""
    echo "é¸é …:"
    echo "  -h, --help     é¡¯ç¤ºæ­¤å¹«åŠ©ä¿¡æ¯"
    echo "  -c, --check    é‹è¡Œå®Œæ•´å®‰å…¨æª¢æŸ¥"
    echo "  -e, --env      åªæª¢æŸ¥ç’°å¢ƒè®Šæ•¸æ–‡ä»¶"
    echo "  -g, --git      åªæª¢æŸ¥ .gitignore é…ç½®"
    echo "  -s, --status   é¡¯ç¤º Git ç‹€æ…‹"
    echo "  -v, --version  é¡¯ç¤ºç‰ˆæœ¬ä¿¡æ¯"
    echo ""
    echo "ç¤ºä¾‹:"
    echo "  $0              # é‹è¡Œå®Œæ•´æª¢æŸ¥"
    echo "  $0 -e           # åªæª¢æŸ¥ç’°å¢ƒè®Šæ•¸"
    echo "  $0 -s           # é¡¯ç¤º Git ç‹€æ…‹"
    echo ""
    echo "ğŸ“ é …ç›®æ ¹ç›®éŒ„: $PROJECT_ROOT"
}

# æª¢æŸ¥ç’°å¢ƒè®Šæ•¸æ–‡ä»¶
check_env_files() {
    echo "ğŸ” æª¢æŸ¥ç’°å¢ƒè®Šæ•¸æ–‡ä»¶..."
    echo "================================"
    
    cd "$PROJECT_ROOT" || exit 1
    
    if git ls-files | grep -E "\.env$|\.env\."; then
        echo "âŒ è­¦å‘Šï¼šç™¼ç¾ç’°å¢ƒè®Šæ•¸æ–‡ä»¶è¢« Git è¿½è¹¤ï¼"
        echo "   é€™äº›æ–‡ä»¶åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œæ‡‰è©²ç«‹å³ç§»é™¤ï¼š"
        echo ""
        git ls-files | grep -E "\.env$|\.env\." | while read file; do
            echo "   - $file"
        done
        echo ""
        echo "ğŸš¨ ç·Šæ€¥æ“ä½œï¼š"
        echo "   1. ç«‹å³å¾ Git ä¸­ç§»é™¤é€™äº›æ–‡ä»¶ï¼š"
        echo "      git rm --cached .env*"
        echo "   2. æäº¤æ›´æ”¹ï¼š"
        echo "      git commit -m 'Remove sensitive environment files'"
        echo "   3. æª¢æŸ¥ .gitignore æ˜¯å¦æ­£ç¢ºé…ç½®"
        echo ""
        return 1
    else
        echo "âœ… æ²’æœ‰ç’°å¢ƒè®Šæ•¸æ–‡ä»¶è¢« Git è¿½è¹¤"
        return 0
    fi
}

# æª¢æŸ¥ .gitignore é…ç½®
check_gitignore() {
    echo "ğŸ” æª¢æŸ¥ .gitignore é…ç½®..."
    echo "================================"
    
    cd "$PROJECT_ROOT" || exit 1
    
    if [ -f ".gitignore" ]; then
        if grep -q "\.env" .gitignore; then
            echo "âœ… æ ¹ç›®éŒ„ .gitignore åŒ…å« .env æ¨¡å¼"
        else
            echo "âŒ æ ¹ç›®éŒ„ .gitignore ç¼ºå°‘ .env æ¨¡å¼"
        fi
    else
        echo "âŒ æ ¹ç›®éŒ„ç¼ºå°‘ .gitignore æ–‡ä»¶"
    fi
    
    echo ""
    echo "ğŸ“‹ æª¢æŸ¥å­ç›®éŒ„ .gitignore..."
    for dir in admin functions web; do
        if [ -d "$dir" ]; then
            if [ -f "$dir/.gitignore" ]; then
                if grep -q "\.env" "$dir/.gitignore"; then
                    echo "âœ… $dir/.gitignore é…ç½®æ­£ç¢º"
                else
                    echo "âš ï¸  $dir/.gitignore ç¼ºå°‘ .env ä¿è­·"
                fi
            else
                echo "âŒ $dir/ ç›®éŒ„ç¼ºå°‘ .gitignore æ–‡ä»¶"
            fi
        fi
    done
}

# é¡¯ç¤º Git ç‹€æ…‹
show_git_status() {
    echo "ğŸ” Git ç‹€æ…‹æª¢æŸ¥..."
    echo "================================"
    
    cd "$PROJECT_ROOT" || exit 1
    
    echo "ğŸ“‹ ç•¶å‰åˆ†æ”¯:"
    git branch --show-current
    
    echo ""
    echo "ğŸ“‹ æœ€è¿‘æäº¤:"
    git log --oneline -5
    
    echo ""
    echo "ğŸ“‹ æš«å­˜å€ç‹€æ…‹:"
    git status --porcelain | head -10
    
    echo ""
    echo "ğŸ“‹ æœªè¿½è¹¤æ–‡ä»¶ (å‰10å€‹):"
    git status --porcelain | grep "^??" | head -10
}

# é‹è¡Œå®Œæ•´æª¢æŸ¥
run_full_check() {
    echo "ğŸ” é–‹å§‹å®Œæ•´ Git å®‰å…¨æª¢æŸ¥..."
    echo "================================"
    echo "ğŸ“ é …ç›®æ ¹ç›®éŒ„: $PROJECT_ROOT"
    echo ""
    
    cd "$PROJECT_ROOT" || exit 1
    
    # æª¢æŸ¥ç’°å¢ƒè®Šæ•¸æ–‡ä»¶
    if ! check_env_files; then
        echo ""
        echo "âŒ ç’°å¢ƒè®Šæ•¸æª¢æŸ¥å¤±æ•—ï¼è«‹ç«‹å³è™•ç†ä¸Šè¿°å•é¡Œã€‚"
        return 1
    fi
    
    echo ""
    
    # æª¢æŸ¥ .gitignore é…ç½®
    check_gitignore
    
    echo ""
    
    # æª¢æŸ¥æœ€è¿‘æäº¤ä¸­çš„æ•æ„Ÿä¿¡æ¯
    echo "ğŸ“‹ æª¢æŸ¥æœ€è¿‘æäº¤ä¸­çš„æ•æ„Ÿä¿¡æ¯..."
    if git log --oneline -10 | grep -i "env\|config\|secret\|key\|password\|token"; then
        echo "âš ï¸  ç™¼ç¾å¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯çš„æäº¤"
        echo "   å»ºè­°æª¢æŸ¥é€™äº›æäº¤çš„å…§å®¹ï¼š"
        git log --oneline -10 | grep -i "env\|config\|secret\|key\|password\|token"
    else
        echo "âœ… æœ€è¿‘æäº¤ä¸­æ²’æœ‰ç™¼ç¾æ˜é¡¯çš„æ•æ„Ÿä¿¡æ¯"
    fi
    
    echo ""
    echo "================================"
    echo "ğŸ” å®Œæ•´å®‰å…¨æª¢æŸ¥å®Œæˆï¼"
    
    # æä¾›å®‰å…¨å»ºè­°
    echo ""
    echo "ğŸ’¡ å®‰å…¨å»ºè­°ï¼š"
    echo "1. æ°¸é ä¸è¦æäº¤ .env æ–‡ä»¶"
    echo "2. ä½¿ç”¨ç’°å¢ƒè®Šæ•¸ç®¡ç†æ•æ„Ÿä¿¡æ¯"
    echo "3. å®šæœŸæª¢æŸ¥ .gitignore é…ç½®"
    echo "4. å¦‚æœç™¼ç¾æ•æ„Ÿä¿¡æ¯è¢«æäº¤ï¼Œç«‹å³ç§»é™¤ä¸¦æ›´æ›å¯†é‘°"
    echo "5. ä½¿ç”¨ git-secrets ç­‰å·¥å…·é€²è¡Œè‡ªå‹•æª¢æŸ¥"
}

# ä¸»å‡½æ•¸
main() {
    case "${1:-}" in
        -h|--help)
            show_help
            ;;
        -c|--check)
            run_full_check
            ;;
        -e|--env)
            check_env_files
            ;;
        -g|--git)
            check_gitignore
            ;;
        -s|--status)
            show_git_status
            ;;
        -v|--version)
            echo "ğŸ” ShopBot å®‰å…¨æª¢æŸ¥å·¥å…· v1.0.0"
            echo "ğŸ“ é …ç›®æ ¹ç›®éŒ„: $PROJECT_ROOT"
            ;;
        "")
            run_full_check
            ;;
        *)
            echo "âŒ æœªçŸ¥é¸é …: $1"
            echo "ä½¿ç”¨ '$0 --help' æŸ¥çœ‹å¹«åŠ©ä¿¡æ¯"
            exit 1
            ;;
    esac
}

# é‹è¡Œä¸»å‡½æ•¸
main "$@"
