{"fsPath":"/home/a0928997578_gmail_com/ÂÅâÂ§ß/functions/src/telegram-webhook.ts","fileUuid":"b2d44821-0d63-4adc-9f58-1a0b62284acc","fileSizeBytes":6919,"numLines":272,"diffChanges":[{"originalStartLineNumberOneIndexed":1,"originalEndLineNumberExclusiveOneIndexed":1,"modifiedStartLineNumberOneIndexed":1,"modifiedEndLineNumberExclusiveOneIndexed":273,"addedLines":["import { onRequest } from 'firebase-functions/v2/https';","import { TelegramBotService } from './services/telegram';","import { AuthService } from './services/auth';","import { DatabaseService } from './services/database';","","// Telegram Webhook ËôïÁêÜÂô®","export const telegramWebhook = onRequest({","  cors: true,","  maxInstances: 10","}, async (req, res) => {","  try {","    // Âè™ËôïÁêÜ POST Ë´ãÊ±Ç","    if (req.method !== 'POST') {","      return res.status(405).json({ error: 'Method not allowed' });","    }","","    const update = req.body;","    console.log('Received Telegram update:', JSON.stringify(update, null, 2));","","    // ËôïÁêÜÂõûË™øÊü•Ë©¢","    if (update.callback_query) {","      await TelegramBotService.handleCallbackQuery(update.callback_query);","      return res.json({ success: true });","    }","","    // ËôïÁêÜÊ∂àÊÅØ","    if (update.message) {","      const message = update.message;","      const chatId = message.chat.id;","      const from = message.from;","      const text = message.text;","","      // Ê™¢Êü•ÊòØÂê¶ÁÇ∫ÁßÅËÅä","      if (message.chat.type !== 'private') {","        return res.json({ success: true });","      }","","      // ËôïÁêÜÂëΩ‰ª§","      if (text && text.startsWith('/')) {","        await handleCommand(chatId, from, text);","      } else if (text) {","        // ËôïÁêÜÊôÆÈÄöÊñáÊú¨Ê∂àÊÅØ","        await handleTextMessage(chatId, from, text);","      }","","      return res.json({ success: true });","    }","","    res.json({ success: true });","  } catch (error) {","    console.error('Error processing Telegram webhook:', error);","    res.status(500).json({ error: 'Internal server error' });","  }","});","","// ËôïÁêÜÂëΩ‰ª§","async function handleCommand(chatId: number, from: any, command: string) {","  try {","    switch (command) {","      case '/start':","        await handleStartCommand(chatId, from);","        break;","        ","      case '/help':","        await TelegramBotService.sendHelpKeyboard(chatId);","        break;","        ","      case '/menu':","        await handleStartCommand(chatId, from);","        break;","        ","      case '/products':","        const categories = await DatabaseService.getCategories();","        await TelegramBotService.sendCategoryKeyboard(chatId, categories);","        break;","        ","      case '/cart':","        await TelegramBotService.sendCartKeyboard(chatId, []);","        break;","        ","      case '/orders':","        await TelegramBotService.sendMessage(chatId, 'üìã Ê≠£Âú®Êü•Ë©¢ÊÇ®ÁöÑË®ÇÂñÆ...');","        break;","        ","      case '/agent':","        await TelegramBotService.sendAgentSystemKeyboard(chatId);","        break;","        ","      case '/language':","        await TelegramBotService.sendLanguageKeyboard(chatId);","        break;","        ","      default:","        await TelegramBotService.sendMessage(chatId, ","          `‚ùì Êú™Áü•ÂëΩ‰ª§Ôºö${command}\\n\\nüí° ‰ΩøÁî® /help Êü•ÁúãÂèØÁî®ÂëΩ‰ª§„ÄÇ`","        );","        break;","    }","  } catch (error) {","    console.error('Error handling command:', error);","    await TelegramBotService.sendMessage(chatId, '‚ùå ËôïÁêÜÂëΩ‰ª§ÊôÇÁôºÁîüÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ');","  }","}","","// ËôïÁêÜÈñãÂßãÂëΩ‰ª§","async function handleStartCommand(chatId: number, from: any) {","  try {","    // ÂâµÂª∫ÊàñÁç≤ÂèñÁî®Êà∂","    const user = await AuthService.createOrGetUser({","      telegramId: from.id,","      username: from.username,","      firstName: from.first_name,","      lastName: from.last_name,","      languageCode: from.language_code","    });","","    // ÁôºÈÄÅÊ≠°ËøéÊ∂àÊÅØ","    await TelegramBotService.sendWelcomeMessage(chatId, user);","    ","    // ÁôºÈÄÅ‰ΩøÁî®ÊèêÁ§∫","    setTimeout(async () => {","      await TelegramBotService.sendMessage(chatId, ","        `üí° <b>‰ΩøÁî®ÊèêÁ§∫</b>\\n\\n` +","        `‚Ä¢ ÈªûÊìäÊåâÈàïÈÄ≤Ë°åÊìç‰Ωú\\n` +","        `‚Ä¢ ‰ΩøÁî® /menu ËøîÂõû‰∏ªÈÅ∏ÂñÆ\\n` +","        `‚Ä¢ ‰ΩøÁî® /help Áç≤ÂèñÂπ´Âä©\\n` +","        `‚Ä¢ 24/7 ÂÆ¢ÊúçÈö®ÊôÇÁÇ∫ÊÇ®ÊúçÂãô`","      );","    }, 2000);","","  } catch (error) {","    console.error('Error handling start command:', error);","    await TelegramBotService.sendMessage(chatId, '‚ùå ÂàùÂßãÂåñÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ');","  }","}","","// ËôïÁêÜÊñáÊú¨Ê∂àÊÅØ","async function handleTextMessage(chatId: number, from: any, text: string) {","  try {","    // Ê™¢Êü•ÊòØÂê¶ÁÇ∫ÊêúÂ∞ãË´ãÊ±Ç","    if (text.length > 2 && text.length < 50) {","      await handleSearchRequest(chatId, text);","      return;","    }","","    // Ê™¢Êü•ÊòØÂê¶ÁÇ∫ÂÆ¢ÊúçÊ∂àÊÅØ","    if (text.toLowerCase().includes('ÂÆ¢Êúç') || text.toLowerCase().includes('help')) {","      await TelegramBotService.sendMessage(chatId, ","        `üìû <b>ÂÆ¢ÊúçÊîØÊè¥</b>\\n\\n` +","        `‚Ä¢ 24/7 Âú®Á∑öÂÆ¢Êúç\\n` +","        `‚Ä¢ Â∞àÊ•≠ÊäÄË°ìÊîØÊè¥\\n` +","        `‚Ä¢ Âø´ÈÄüÂïèÈ°åËß£Ê±∫\\n\\n` +","        `üí¨ Ë´ãÊèèËø∞ÊÇ®ÁöÑÂïèÈ°åÔºåÂÆ¢ÊúçÊúÉÁõ°Âø´ÂõûË¶ÜÊÇ®„ÄÇ`","      );","      return;","    }","","    // ÈªòË™çÂõûÊáâ","    await TelegramBotService.sendMessage(chatId, ","      `üí¨ Êî∂Âà∞ÊÇ®ÁöÑÊ∂àÊÅØÔºö${text}\\n\\n` +","      `üí° Ë´ã‰ΩøÁî®ÊåâÈàïÊàñÂëΩ‰ª§ÈÄ≤Ë°åÊìç‰Ωú„ÄÇ\\n` +","      `üîô ‰ΩøÁî® /menu ËøîÂõû‰∏ªÈÅ∏ÂñÆ„ÄÇ`","    );","","  } catch (error) {","    console.error('Error handling text message:', error);","    await TelegramBotService.sendMessage(chatId, '‚ùå ËôïÁêÜÊ∂àÊÅØÊôÇÁôºÁîüÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ');","  }","}","","// ËôïÁêÜÊêúÂ∞ãË´ãÊ±Ç","async function handleSearchRequest(chatId: number, searchTerm: string) {","  try {","    // ÈÄôË£°ÈúÄË¶ÅÂØ¶ÁèæÂïÜÂìÅÊêúÂ∞ãÈÇèËºØ","    await TelegramBotService.sendMessage(chatId, ","      `üîç Ê≠£Âú®ÊêúÂ∞ã„Äå${searchTerm}„Äç...\\n\\n` +","      `üí° ÊêúÂ∞ãÂäüËÉΩÈñãÁôº‰∏≠ÔºåË´ãÁ®çÂæå‰ΩøÁî®„ÄÇ`","    );","  } catch (error) {","    console.error('Error handling search request:', error);","    await TelegramBotService.sendMessage(chatId, '‚ùå ÊêúÂ∞ãÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ');","  }","}","","// Ë®≠ÁΩÆ Webhook ÁöÑËºîÂä©ÂáΩÊï∏","export const setWebhook = onRequest(async (req, res) => {","  try {","    const webhookUrl = process.env.TELEGRAM_WEBHOOK_URL;","    const botToken = process.env.TELEGRAM_BOT_TOKEN;","    ","    if (!webhookUrl || !botToken) {","      return res.status(500).json({ ","        error: 'Missing webhook URL or bot token' ","      });","    }","","    const response = await fetch(","      `https://api.telegram.org/bot${botToken}/setWebhook`,","      {","        method: 'POST',","        headers: {","          'Content-Type': 'application/json',","        },","        body: JSON.stringify({","          url: webhookUrl,","          allowed_updates: ['message', 'callback_query']","        })","      }","    );","","    const result = await response.json();","    ","    if (result.ok) {","      res.json({ ","        success: true, ","        message: 'Webhook set successfully',","        result ","      });","    } else {","      res.status(400).json({ ","        success: false, ","        error: 'Failed to set webhook',","        result ","      });","    }","  } catch (error) {","    console.error('Error setting webhook:', error);","    res.status(500).json({ ","      success: false, ","      error: 'Internal server error' ","    });","  }","});","","// Áç≤Âèñ Bot ‰ø°ÊÅØÁöÑËºîÂä©ÂáΩÊï∏","export const getBotInfo = onRequest(async (req, res) => {","  try {","    const botToken = process.env.TELEGRAM_BOT_TOKEN;","    ","    if (!botToken) {","      return res.status(500).json({ ","        error: 'Missing bot token' ","      });","    }","","    const response = await fetch(","      `https://api.telegram.org/bot${botToken}/getMe`","    );","","    const result = await response.json();","    ","    if (result.ok) {","      res.json({ ","        success: true, ","        botInfo: result.result ","      });","    } else {","      res.status(400).json({ ","        success: false, ","        error: 'Failed to get bot info',","        result ","      });","    }","  } catch (error) {","    console.error('Error getting bot info:', error);","    res.status(500).json({ ","      success: false, ","      error: 'Internal server error' ","    });","  }","});",""],"tokenizedAddedLines":[1000000,1000001,1000002,1000003,1000004,1000005,1000006,1000007,1000008,1000009,1000010,1000011,1000012,1000013,1000014,1000004,1000015,1000016,1000004,1000017,1000018,1000019,1000020,1000014,1000004,1000021,1000022,1000023,1000024,1000025,1000026,1000004,1000027,1000028,1000029,1000030,1000004,1000031,1000032,1000033,1000034,1000035,1000036,1000030,1000004,1000020,1000014,1000004,1000037,1000038,1000039,1000040,1000041,1000042,1000004,1000043,1000044,1000010,1000045,1000046,1000047,1000048,1000049,1000050,1000051,1000048,1000049,1000052,1000047,1000048,1000049,1000053,1000054,1000055,1000048,1000049,1000056,1000057,1000048,1000049,1000058,1000059,1000048,1000049,1000060,1000061,1000048,1000049,1000062,1000063,1000048,1000049,1000064,1000065,1000066,1000067,1000048,1000014,1000038,1000068,1000069,1000041,1000070,1000004,1000071,1000072,1000010,1000073,1000074,1000075,1000076,1000077,1000078,1000079,1000080,1000004,1000081,1000082,1000083,1000084,1000085,1000086,1000087,1000088,1000089,1000090,1000091,1000092,1000093,1000004,1000038,1000094,1000095,1000041,1000070,1000004,1000096,1000097,1000010,1000098,1000099,1000100,1000101,1000014,1000004,1000102,1000103,1000086,1000104,1000105,1000106,1000107,1000108,1000092,1000101,1000014,1000004,1000109,1000110,1000111,1000112,1000113,1000114,1000004,1000038,1000115,1000116,1000041,1000070,1000004,1000117,1000118,1000010,1000119,1000110,1000120,1000121,1000114,1000038,1000122,1000123,1000041,1000070,1000004,1000124,1000125,1000010,1000126,1000127,1000083,1000128,1000129,1000130,1000131,1000014,1000004,1000132,1000133,1000134,1000135,1000136,1000137,1000138,1000139,1000140,1000141,1000142,1000030,1000114,1000004,1000143,1000083,1000144,1000145,1000146,1000147,1000148,1000131,1000149,1000150,1000151,1000152,1000148,1000131,1000014,1000038,1000153,1000154,1000155,1000156,1000080,1000041,1000042,1000004,1000157,1000158,1000010,1000127,1000083,1000159,1000129,1000160,1000131,1000014,1000004,1000132,1000161,1000114,1000004,1000143,1000083,1000144,1000145,1000146,1000162,1000131,1000149,1000150,1000151,1000163,1000148,1000131,1000014,1000038,1000164,1000154,1000155,1000156,1000080,1000041,1000042,1000004]}],"gitInfo":{"noRepoFound":true},"kind":"KIND_ADDED"}