{"fsPath":"/home/a0928997578_gmail_com/偉大/functions/src/services/telegram.ts","fileUuid":"08527341-1882-4b85-be87-9c818eecd6fe","fileSizeBytes":33130,"numLines":1170,"diffChanges":[{"originalStartLineNumberOneIndexed":7,"originalEndLineNumberExclusiveOneIndexed":7,"modifiedStartLineNumberOneIndexed":7,"modifiedEndLineNumberExclusiveOneIndexed":8,"addedLines":["import { agentService } from './agent';"],"tokenizedAddedLines":[1000374]},{"originalStartLineNumberOneIndexed":406,"originalEndLineNumberExclusiveOneIndexed":406,"modifiedStartLineNumberOneIndexed":407,"modifiedEndLineNumberExclusiveOneIndexed":415,"addedLines":["      [","        { text: '💳 申請提現', callback_data: 'agent_withdrawal' },","        { text: '📈 績效分析', callback_data: 'agent_performance' }","      ],","      [","        { text: '🔗 推薦碼', callback_data: 'agent_referral' },","        { text: '📝 註冊代理', callback_data: 'agent_register' }","      ],"],"tokenizedAddedLines":[55,1000375,1000376,58,55,1000377,1000378,58]},{"originalStartLineNumberOneIndexed":507,"originalEndLineNumberExclusiveOneIndexed":507,"modifiedStartLineNumberOneIndexed":516,"modifiedEndLineNumberExclusiveOneIndexed":549,"addedLines":["        // 代理系統相關回調","        case 'agent_status':","          await this.handleAgentStatus(from.id);","          break;","          ","        case 'agent_earnings':","          await this.handleAgentEarnings(from.id);","          break;","          ","        case 'agent_team':","          await this.handleAgentTeam(from.id);","          break;","          ","        case 'agent_orders':","          await this.handleAgentOrders(from.id);","          break;","          ","        case 'agent_withdrawal':","          await this.handleAgentWithdrawal(from.id);","          break;","          ","        case 'agent_performance':","          await this.handleAgentPerformance(from.id);","          break;","          ","        case 'agent_referral':","          await this.handleAgentReferral(from.id);","          break;","          ","        case 'agent_register':","          await this.handleAgentRegister(from.id);","          break;","          "],"tokenizedAddedLines":[1000379,1000380,1000381,256,257,1000382,1000383,256,257,1000384,1000385,256,257,1000386,1000387,256,257,1000388,1000389,256,257,1000390,1000391,256,257,1000392,1000393,256,257,1000394,1000395,256,257]},{"originalStartLineNumberOneIndexed":662,"originalEndLineNumberExclusiveOneIndexed":662,"modifiedStartLineNumberOneIndexed":704,"modifiedEndLineNumberExclusiveOneIndexed":1169,"addedLines":["","  // 代理系統處理方法","  ","  // 處理代理狀態查詢","  static async handleAgentStatus(chatId: number) {","    try {","      const agent = await agentService.getAgentByTelegramId(chatId);","      ","      if (!agent) {","        await this.sendMessage(chatId, '❌ 您還不是代理，請先註冊成為代理。');","        return;","      }","","      const statusText = `📊 <b>代理狀態</b>","","👤 <b>代理信息</b>","• 姓名：${agent.firstName}","• 等級：${agent.level.icon} ${agent.level.name}","• 狀態：${this.getAgentStatusText(agent.status)}","• 推薦碼：<code>${agent.referralCode}</code>","","💰 <b>收益統計</b>","• 總銷售額：${agent.totalSales.toFixed(2)} USDT","• 總佣金：${agent.totalCommission.toFixed(2)} USDT","• 可提現：${agent.availableCommission.toFixed(2)} USDT","","👥 <b>團隊信息</b>","• 團隊人數：${agent.teamSize} 人","• 團隊銷售：${agent.teamSales.toFixed(2)} USDT","","📅 <b>加入時間</b>","• ${agent.joinDate.toLocaleDateString('zh-TW')}`;","","      const keyboard = [","        [","          { text: '💰 收益查詢', callback_data: 'agent_earnings' },","          { text: '👥 團隊管理', callback_data: 'agent_team' }","        ],","        [","          { text: '🔙 返回代理系統', callback_data: 'agent_system' }","        ]","      ];","","      await this.sendMessageWithKeyboard(chatId, statusText, keyboard);","    } catch (error) {","      console.error('處理代理狀態查詢失敗:', error);","      await this.sendMessage(chatId, '❌ 獲取代理狀態失敗，請稍後再試。');","    }","  }","","  // 處理代理收益查詢","  static async handleAgentEarnings(chatId: number) {","    try {","      const agent = await agentService.getAgentByTelegramId(chatId);","      ","      if (!agent) {","        await this.sendMessage(chatId, '❌ 您還不是代理，請先註冊成為代理。');","        return;","      }","","      const earningsText = `💰 <b>代理收益</b>","","📊 <b>收益概覽</b>","• 總銷售額：${agent.totalSales.toFixed(2)} USDT","• 總佣金：${agent.totalCommission.toFixed(2)} USDT","• 可提現：${agent.availableCommission.toFixed(2)} USDT","• 佣金比例：${agent.commissionRate}%","","📈 <b>等級權益</b>","• 當前等級：${agent.level.icon} ${agent.level.name}","• 等級要求：銷售額 ${agent.level.minSales} USDT，團隊 ${agent.level.minTeamSize} 人","• 下級等級：${this.getNextLevelInfo(agent.level.level)}","","💡 <b>提升建議</b>","${this.getLevelUpgradeAdvice(agent)}`;","","      const keyboard = [","        [","          { text: '💳 申請提現', callback_data: 'agent_withdrawal' },","          { text: '📈 績效分析', callback_data: 'agent_performance' }","        ],","        [","          { text: '🔙 返回代理系統', callback_data: 'agent_system' }","        ]","      ];","","      await this.sendMessageWithKeyboard(chatId, earningsText, keyboard);","    } catch (error) {","      console.error('處理代理收益查詢失敗:', error);","      await this.sendMessage(chatId, '❌ 獲取代理收益失敗，請稍後再試。');","    }","  }","","  // 處理代理團隊管理","  static async handleAgentTeam(chatId: number) {","    try {","      const agent = await agentService.getAgentByTelegramId(chatId);","      ","      if (!agent) {","        await this.sendMessage(chatId, '❌ 您還不是代理，請先註冊成為代理。');","        return;","      }","","      const team = await agentService.getAgentTeam(agent.id);","      ","      let teamText = `👥 <b>團隊管理</b>","","📊 <b>團隊概覽</b>","• 團隊人數：${agent.teamSize} 人","• 團隊銷售：${agent.teamSales.toFixed(2)} USDT","","📋 <b>團隊成員</b>`;","","      if (team.length === 0) {","        teamText += '\\n• 暫無團隊成員';","      } else {","        team.forEach((member, index) => {","          teamText += `\\n${index + 1}. ${member.memberType === 'direct' ? '直接' : '間接'}成員 (${member.totalSales.toFixed(2)} USDT)`;","        });","      }","","      teamText += `\\n\\n💡 <b>團隊建設建議</b>","• 積極推薦新代理加入","• 幫助團隊成員提升業績","• 定期溝通和培訓`;","","      const keyboard = [","        [","          { text: '🔗 推薦碼', callback_data: 'agent_referral' },","          { text: '📈 績效分析', callback_data: 'agent_performance' }","        ],","        [","          { text: '🔙 返回代理系統', callback_data: 'agent_system' }","        ]","      ];","","      await this.sendMessageWithKeyboard(chatId, teamText, keyboard);","    } catch (error) {","      console.error('處理代理團隊管理失敗:', error);","      await this.sendMessage(chatId, '❌ 獲取團隊信息失敗，請稍後再試。');","    }","  }","","  // 處理代理訂單查詢","  static async handleAgentOrders(chatId: number) {","    try {","      const agent = await agentService.getAgentByTelegramId(chatId);","      ","      if (!agent) {","        await this.sendMessage(chatId, '❌ 您還不是代理，請先註冊成為代理。');","        return;","      }","","      const ordersText = `📋 <b>代理訂單</b>","","📊 <b>訂單統計</b>","• 總訂單數：${agent.totalSales > 0 ? Math.ceil(agent.totalSales / 100) : 0} 筆","• 平均訂單金額：${agent.totalSales > 0 ? (agent.totalSales / Math.ceil(agent.totalSales / 100)).toFixed(2) : 0} USDT","","💡 <b>訂單管理</b>","• 關注客戶訂單狀態","• 及時處理售後問題","• 提升客戶滿意度`;","","      const keyboard = [","        [","          { text: '💰 收益查詢', callback_data: 'agent_earnings' },","          { text: '📈 績效分析', callback_data: 'agent_performance' }","        ],","        [","          { text: '🔙 返回代理系統', callback_data: 'agent_system' }","        ]","      ];","","      await this.sendMessageWithKeyboard(chatId, ordersText, keyboard);","    } catch (error) {","      console.error('處理代理訂單查詢失敗:', error);","      await this.sendMessage(chatId, '❌ 獲取訂單信息失敗，請稍後再試。');","    }","  }","","  // 處理代理提現申請","  static async handleAgentWithdrawal(chatId: number) {","    try {","      const agent = await agentService.getAgentByTelegramId(chatId);","      ","      if (!agent) {","        await this.sendMessage(chatId, '❌ 您還不是代理，請先註冊成為代理。');","        return;","      }","","      if (agent.availableCommission < 50) {","        await this.sendMessage(chatId, `❌ 可提現佣金不足。\\n\\n💰 當前可提現：${agent.availableCommission.toFixed(2)} USDT\\n💳 最低提現金額：50 USDT`);","        return;","      }","","      const withdrawalText = `💳 <b>申請提現</b>","","💰 <b>提現信息</b>","• 可提現佣金：${agent.availableCommission.toFixed(2)} USDT","• 最低提現：50 USDT","• 手續費：2%","• 處理時間：24小時內","","📝 <b>提現流程</b>","1. 聯繫客服申請提現","2. 提供錢包地址","3. 確認提現金額","4. 等待處理完成","","💡 <b>注意事項</b>","• 請確保錢包地址正確","• 提現手續費將從提現金額中扣除","• 如有問題請聯繫客服`;","","      const keyboard = [","        [","          { text: '📞 聯繫客服', callback_data: 'contact_support' },","          { text: '💰 收益查詢', callback_data: 'agent_earnings' }","        ],","        [","          { text: '🔙 返回代理系統', callback_data: 'agent_system' }","        ]","      ];","","      await this.sendMessageWithKeyboard(chatId, withdrawalText, keyboard);","    } catch (error) {","      console.error('處理代理提現申請失敗:', error);","      await this.sendMessage(chatId, '❌ 處理提現申請失敗，請稍後再試。');","    }","  }","","  // 處理代理績效分析","  static async handleAgentPerformance(chatId: number) {","    try {","      const agent = await agentService.getAgentByTelegramId(chatId);","      ","      if (!agent) {","        await this.sendMessage(chatId, '❌ 您還不是代理，請先註冊成為代理。');","        return;","      }","","      const performance = await agentService.getAgentPerformance(","        agent.id,","        'monthly',","        new Date(new Date().getFullYear(), new Date().getMonth(), 1),","        new Date()","      );","","      const performanceText = `📈 <b>績效分析</b>","","📊 <b>本月績效</b>","• 訂單數量：${performance.totalOrders} 筆","• 銷售金額：${performance.totalSales.toFixed(2)} USDT","• 佣金收入：${performance.totalCommission.toFixed(2)} USDT","• 平均訂單：${performance.averageOrderValue.toFixed(2)} USDT","","🎯 <b>目標達成</b>","• 銷售目標：${this.getSalesTarget(agent.level.level)} USDT","• 完成進度：${this.getProgressPercentage(agent.totalSales, this.getSalesTarget(agent.level.level))}%","","💡 <b>提升建議</b>","${this.getPerformanceAdvice(agent, performance)}`;","","      const keyboard = [","        [","          { text: '💰 收益查詢', callback_data: 'agent_earnings' },","          { text: '👥 團隊管理', callback_data: 'agent_team' }","        ],","        [","          { text: '🔙 返回代理系統', callback_data: 'agent_system' }","        ]","      ];","","      await this.sendMessageWithKeyboard(chatId, performanceText, keyboard);","    } catch (error) {","      console.error('處理代理績效分析失敗:', error);","      await this.sendMessage(chatId, '❌ 獲取績效分析失敗，請稍後再試。');","    }","  }","","  // 處理代理推薦碼","  static async handleAgentReferral(chatId: number) {","    try {","      const agent = await agentService.getAgentByTelegramId(chatId);","      ","      if (!agent) {","        await this.sendMessage(chatId, '❌ 您還不是代理，請先註冊成為代理。');","        return;","      }","","      const referralText = `🔗 <b>推薦碼</b>","","🎯 <b>您的推薦碼</b>","• 推薦碼：<code>${agent.referralCode}</code>","• 分享鏈接：https://t.me/your_bot?start=${agent.referralCode}","","💰 <b>推薦獎勵</b>","• 推薦新代理：10 USDT 獎金","• 新代理首單：額外佣金","• 團隊建設：長期收益","","📱 <b>分享方式</b>","1. 複製推薦碼發送給朋友","2. 分享專屬鏈接","3. 在社交媒體宣傳","4. 線下推廣活動","","💡 <b>推廣技巧</b>","• 突出產品優勢","• 分享成功案例","• 提供專業建議","• 建立信任關係`;","","      const keyboard = [","        [","          { text: '📋 複製推薦碼', callback_data: 'copy_referral_code' },","          { text: '🔗 分享鏈接', callback_data: 'share_referral_link' }","        ],","        [","          { text: '💰 收益查詢', callback_data: 'agent_earnings' },","          { text: '👥 團隊管理', callback_data: 'agent_team' }","        ],","        [","          { text: '🔙 返回代理系統', callback_data: 'agent_system' }","        ]","      ];","","      await this.sendMessageWithKeyboard(chatId, referralText, keyboard);","    } catch (error) {","      console.error('處理代理推薦碼失敗:', error);","      await this.sendMessage(chatId, '❌ 獲取推薦碼失敗，請稍後再試。');","    }","  }","","  // 處理代理註冊","  static async handleAgentRegister(chatId: number) {","    try {","      const existingAgent = await agentService.getAgentByTelegramId(chatId);","      ","      if (existingAgent) {","        await this.sendMessage(chatId, '✅ 您已經是代理了！\\n\\n📊 查看代理狀態：/agent_status');","        return;","      }","","      const registerText = `📝 <b>代理註冊</b>","","🎯 <b>成為代理的好處</b>","• 銷售佣金：5%-18%","• 團隊獎勵：額外收益","• 推薦獎金：10 USDT","• 等級晉升：更多權益","","📋 <b>註冊要求</b>","• 年滿18歲","• 有銷售經驗","• 願意推廣產品","• 遵守代理規則","","💡 <b>註冊流程</b>","1. 填寫基本信息","2. 等待審核通過","3. 開始推廣銷售","4. 獲得佣金收益","","🔗 <b>開始註冊</b>","請聯繫客服進行代理註冊，或使用推薦碼註冊。`;","","      const keyboard = [","        [","          { text: '📞 聯繫客服', callback_data: 'contact_support' },","          { text: '🔗 使用推薦碼', callback_data: 'use_referral_code' }","        ],","        [","          { text: '🔙 返回代理系統', callback_data: 'agent_system' }","        ]","      ];","","      await this.sendMessageWithKeyboard(chatId, registerText, keyboard);","    } catch (error) {","      console.error('處理代理註冊失敗:', error);","      await this.sendMessage(chatId, '❌ 處理代理註冊失敗，請稍後再試。');","    }","  }","","  // 輔助方法","  ","  // 獲取代理狀態文本","  private static getAgentStatusText(status: string): string {","    const statusMap: { [key: string]: string } = {","      'pending': '待審核',","      'active': '活躍',","      'suspended': '暫停',","      'terminated': '終止',","      'inactive': '不活躍'","    };","    return statusMap[status] || '未知';","  }","","  // 獲取下級等級信息","  private static getNextLevelInfo(currentLevel: number): string {","    if (currentLevel >= 5) return '已達最高等級';","    ","    const nextLevels = [","      '銀牌代理 (1000 USDT, 5人)',","      '金牌代理 (5000 USDT, 15人)',","      '白金代理 (15000 USDT, 30人)',","      '鑽石代理 (50000 USDT, 50人)'","    ];","    ","    return nextLevels[currentLevel - 1] || '未知';","  }","","  // 獲取等級升級建議","  private static getLevelUpgradeAdvice(agent: any): string {","    const currentLevel = agent.level.level;","    const nextLevel = currentLevel + 1;","    ","    if (nextLevel > 5) return '🎉 恭喜！您已達到最高等級。';","    ","    const nextLevels = [","      { sales: 1000, team: 5 },","      { sales: 5000, team: 15 },","      { sales: 15000, team: 30 },","      { sales: 50000, team: 50 }","    ];","    ","    const target = nextLevels[currentLevel - 1];","    if (!target) return '💡 繼續努力，提升業績！';","    ","    const salesDiff = target.sales - agent.totalSales;","    const teamDiff = target.team - agent.teamSize;","    ","    let advice = '💡 升級建議：\\n';","    if (salesDiff > 0) advice += `• 增加銷售額 ${salesDiff.toFixed(2)} USDT\\n`;","    if (teamDiff > 0) advice += `• 擴展團隊 ${teamDiff} 人\\n`;","    ","    return advice;","  }","","  // 獲取銷售目標","  private static getSalesTarget(level: number): number {","    const targets = [0, 1000, 5000, 15000, 50000];","    return targets[level] || 0;","  }","","  // 獲取進度百分比","  private static getProgressPercentage(current: number, target: number): string {","    if (target === 0) return '0%';","    const percentage = (current / target) * 100;","    return Math.min(percentage, 100).toFixed(1) + '%';","  }","","  // 獲取績效建議","  private static getPerformanceAdvice(agent: any, performance: any): string {","    if (performance.totalOrders === 0) {","      return '💡 本月還沒有訂單，建議：\\n• 積極推廣產品\\n• 聯繫潛在客戶\\n• 參加培訓活動';","    }","    ","    if (performance.averageOrderValue < 100) {","      return '💡 平均訂單金額偏低，建議：\\n• 推薦高價值產品\\n• 提供組合優惠\\n• 提升客戶體驗';","    }","    ","    return '💡 業績表現良好，建議：\\n• 保持推廣力度\\n• 擴展客戶群體\\n• 提升服務質量';","  }"],"tokenizedAddedLines":[8,1000396,1000397,1000398,1000399,15,1000400,118,1000401,1000402,1000403,31,8,1000404,8,1000405,1000406,1000407,1000408,1000409,8,1000410,1000411,1000412,1000413,8,1000414,1000415,1000416,8,1000417,1000418,8,119,120,1000419,1000420,123,120,1000421,125,126,8,1000422,33,1000423,1000424,36,37,8,1000425,1000426,15,1000400,118,1000401,1000402,1000403,31,8,1000427,8,1000428,1000411,1000412,1000413,1000429,8,1000430,1000431,1000432,1000433,8,1000434,1000435,8,119,120,1000436,1000437,123,120,1000421,125,126,8,1000438,33,1000439,1000440,36,37,8,1000441,1000442,15,1000400,118,1000401,1000402,1000403,31,8,1000443,118,1000444,8,1000445,1000415,1000416,8,1000446,8,1000447,1000448,1000449,1000450,1000451,1000452,31,8,1000453,1000454,1000455,1000456,8,119,120,1000457,1000437,123,120,1000421,125,126,8,1000458,33,1000459,1000460,36,37,8,1000461,1000462,15,1000400,118,1000401,1000402,1000403,31,8,1000463,8,1000464,1000465,1000466,8,1000467,1000468,1000469,1000470,8,119,120,1000419,1000437,123,120,1000421,125,126,8,1000471,33,1000472,1000473,36,37,8,1000474,1000475,15,1000400,118,1000401,1000402,1000403,31,8,1000476,1000477,1000403,31,8,1000478,8,1000479,1000480,1000481,1000482,1000483,8,1000484,1000485,1000486,1000487,1000488,8,1000489,1000490,1000491,1000492,8,119,120,1000493,1000494,123,120,1000421,125,126,8,1000495,33,1000496,1000497,36,37,8,1000498,1000499,15,1000400,118,1000401,1000402,1000403,31,8,1000500,1000501,1000502,1000503,1000504,92,8,1000505,8,1000506,1000507,1000508,1000509,1000510,8,1000511,1000512,1000513,8,1000434,1000514,8,119,120,1000419,1000420,123,120,1000421,125,126,8,1000515,33,1000516,1000517,36,37,8,1000518,1000519,15,1000400,118,1000401,1000402,1000403,31,8,1000520,8,1000521,1000409,1000522,8,1000523,1000524,1000525,1000526,8,1000527,1000528,1000529,1000530,1000531,8,1000532,1000533,1000534,1000535,1000536,8,119,120,1000537,1000538,123,120,1000419,1000420,123,120,1000421,125,126,8,1000539,33,1000540,1000541,36,37,8,1000542,1000543,15,1000544,118,1000545,1000546,1000403,31,8,1000547,8,1000548,1000549,1000550,1000551,1000552,8,1000553,1000554,1000555,1000556,1000557,8,1000558,1000559,1000560,1000561,1000562,8,1000563,1000564,8,119,120,1000493,1000565,123,120,1000421,125,126,8,1000566,33,1000567,1000568,36,37,8,1000569,1000397,1000570,1000571,1000572,1000573,1000574,1000575,1000576,1000577,1000578,1000579,37,8,1000580,1000581,1000582,73,1000583,1000584,1000585,1000586,1000587,68,73,1000588,37,8,1000589,1000590,1000591,1000592,73,1000593,73,1000583,1000594,1000595,1000596,1000597,68,73,1000598,1000599,73,1000600,1000601,73,1000602,1000603,1000604,73,1000605,37,8,1000606,1000607,1000608,1000609,37,8,1000610,1000611,1000612,1000613,1000614,37,8,1000615,1000616,1000617,1000618,36,73,1000619,1000620,36,73,1000621,37]}],"gitInfo":{"noRepoFound":true},"kind":"KIND_MODIFIED"}