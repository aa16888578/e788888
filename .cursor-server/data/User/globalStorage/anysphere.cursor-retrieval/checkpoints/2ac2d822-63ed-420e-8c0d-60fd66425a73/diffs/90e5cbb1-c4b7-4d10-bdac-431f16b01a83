{"fsPath":"/home/a0928997578_gmail_com/USDT-TRC20-Payment-System/DEPLOYMENT/deploy.sh","fileUuid":"90e5cbb1-c4b7-4d10-bdac-431f16b01a83","fileSizeBytes":3875,"numLines":216,"diffChanges":[{"originalStartLineNumberOneIndexed":1,"originalEndLineNumberExclusiveOneIndexed":1,"modifiedStartLineNumberOneIndexed":1,"modifiedEndLineNumberExclusiveOneIndexed":217,"addedLines":["#!/bin/bash","","# USDT-TRC20 支付系統部署腳本","# 作者: ShopBot Team","# 版本: 1.0.0","","set -e","","# 顏色定義","RED='\\033[0;31m'","GREEN='\\033[0;32m'","YELLOW='\\033[1;33m'","BLUE='\\033[0;34m'","NC='\\033[0m' # No Color","","# 日誌函數","log_info() {","    echo -e \"${BLUE}[INFO]${NC} $1\"","}","","log_success() {","    echo -e \"${GREEN}[SUCCESS]${NC} $1\"","}","","log_warning() {","    echo -e \"${YELLOW}[WARNING]${NC} $1\"","}","","log_error() {","    echo -e \"${RED}[ERROR]${NC} $1\"","}","","# 檢查依賴","check_dependencies() {","    log_info \"檢查系統依賴...\"","    ","    # 檢查 Node.js","    if ! command -v node &> /dev/null; then","        log_error \"Node.js 未安裝，請先安裝 Node.js 18+\"","        exit 1","    fi","    ","    # 檢查 npm","    if ! command -v npm &> /dev/null; then","        log_error \"npm 未安裝，請先安裝 npm\"","        exit 1","    fi","    ","    # 檢查 Docker (可選)","    if command -v docker &> /dev/null; then","        log_info \"Docker 已安裝\"","    else","        log_warning \"Docker 未安裝，將使用本地部署\"","    fi","    ","    log_success \"依賴檢查完成\"","}","","# 環境檢查","check_environment() {","    log_info \"檢查環境配置...\"","    ","    if [ ! -f \".env\" ]; then","        log_error \".env 文件不存在，請先複製 env.example 並配置\"","        exit 1","    fi","    ","    # 檢查必要的環境變數","    source .env","    ","    required_vars=(","        \"TRON_NETWORK\"","        \"TRON_API_KEY\"","        \"USDT_CONTRACT_ADDRESS\"","        \"JWT_SECRET\"","        \"FIREBASE_PROJECT_ID\"","    )","    ","    for var in \"${required_vars[@]}\"; do","        if [ -z \"${!var}\" ]; then","            log_error \"環境變數 $var 未設置\"","            exit 1","        fi","    done","    ","    log_success \"環境配置檢查完成\"","}","","# 安裝依賴","install_dependencies() {","    log_info \"安裝項目依賴...\"","    ","    if [ -f \"package.json\" ]; then","        npm ci --only=production","        log_success \"生產依賴安裝完成\"","    else","        log_error \"package.json 文件不存在\"","        exit 1","    fi","}","","# 構建項目","build_project() {","    log_info \"構建項目...\"","    ","    if [ -f \"tsconfig.json\" ]; then","        npm run build","        log_success \"項目構建完成\"","    else","        log_warning \"TypeScript 配置不存在，跳過構建步驟\"","    fi","}","","# 部署智能合約","deploy_contracts() {","    log_info \"部署智能合約...\"","    ","    if [ -f \"hardhat.config.js\" ] || [ -f \"hardhat.config.ts\" ]; then","        # 根據環境選擇網絡","        if [ \"$TRON_NETWORK\" = \"mainnet\" ]; then","            log_info \"部署到主網...\"","            npm run deploy:contracts","        else","            log_info \"部署到測試網...\"","            npm run deploy:testnet","        fi","        log_success \"智能合約部署完成\"","    else","        log_warning \"Hardhat 配置不存在，跳過合約部署\"","    fi","}","","# 啟動服務","start_service() {","    log_info \"啟動支付服務...\"","    ","    # 檢查是否使用 PM2","    if command -v pm2 &> /dev/null; then","        log_info \"使用 PM2 啟動服務...\"","        pm2 start ecosystem.config.js --env production","        pm2 save","        log_success \"服務已啟動並保存到 PM2\"","    else","        log_info \"使用 npm 啟動服務...\"","        npm start &","        log_success \"服務已啟動\"","    fi","}","","# 健康檢查","health_check() {","    log_info \"執行健康檢查...\"","    ","    # 等待服務啟動","    sleep 5","    ","    # 檢查服務是否響應","    if curl -f http://localhost:3000/health > /dev/null 2>&1; then","        log_success \"服務健康檢查通過\"","    else","        log_error \"服務健康檢查失敗\"","        exit 1","    fi","}","","# 部署後清理","post_deploy_cleanup() {","    log_info \"執行部署後清理...\"","    ","    # 清理構建文件","    if [ -d \"dist\" ]; then","        rm -rf dist","        log_info \"清理構建文件完成\"","    fi","    ","    # 清理緩存","    npm cache clean --force","    log_info \"清理 npm 緩存完成\"","}","","# 主部署流程","main() {","    log_info \"開始部署 USDT-TRC20 支付系統...\"","    ","    # 檢查當前目錄","    if [ ! -f \"package.json\" ]; then","        log_error \"請在項目根目錄執行此腳本\"","        exit 1","    fi","    ","    # 執行部署步驟","    check_dependencies","    check_environment","    install_dependencies","    build_project","    deploy_contracts","    start_service","    health_check","    post_deploy_cleanup","    ","    log_success \"部署完成！\"","    log_info \"服務地址: http://localhost:3000\"","    log_info \"健康檢查: http://localhost:3000/health\"","    ","    if command -v pm2 &> /dev/null; then","        log_info \"PM2 狀態: pm2 status\"","        log_info \"PM2 日誌: pm2 logs\"","    fi","}","","# 錯誤處理","trap 'log_error \"部署過程中發生錯誤，退出碼: $?\"' ERR","","# 執行主函數","main \"$@\"",""],"tokenizedAddedLines":[1000000,1000001,1000002,1000003,1000004,1000001,1000005,1000001,1000006,1000007,1000008,1000009,1000010,1000011,1000001,1000012,1000013,1000014,1000015,1000001,1000016,1000017,1000015,1000001,1000018,1000019,1000015,1000001,1000020,1000021,1000015,1000001,1000022,1000023,1000024,1000025,1000026,1000027,1000028,1000029,1000030,1000025,1000031,1000032,1000033,1000029,1000030,1000025,1000034,1000035,1000036,1000037,1000038,1000030,1000025,1000039,1000015,1000001,1000040,1000041,1000042,1000025,1000043,1000044,1000029,1000030,1000025,1000045,1000046,1000025,1000047,1000048,1000049,1000050,1000051,1000052,1000053,1000025,1000054,1000055,1000056,1000057,1000058,1000059,1000025,1000060,1000015,1000001,1000061,1000062,1000063,1000025,1000064,1000065,1000066,1000037,1000067,1000029,1000030,1000015,1000001,1000068,1000069,1000070,1000025,1000071,1000072,1000073,1000037,1000074,1000030,1000015,1000001,1000075,1000076,1000077,1000025,1000078,1000079,1000080,1000081,1000082,1000083,1000084,1000085,1000058,1000086,1000037,1000087,1000030,1000015,1000001,1000088,1000089,1000090,1000025,1000091,1000092,1000093,1000094,1000095,1000096,1000037,1000097,1000098,1000099,1000030,1000015,1000001,1000100,1000101,1000102,1000025,1000103,1000104,1000025,1000105,1000106,1000107,1000037,1000108,1000029,1000030,1000015,1000001,1000109,1000110,1000111,1000025,1000112,1000113,1000114,1000115,1000030,1000025,1000116,1000117,1000118,1000015,1000001,1000119,1000120,1000121,1000025,1000122,1000123,1000124,1000029,1000030,1000025,1000125,1000126,1000127,1000128,1000129,1000130,1000131,1000132,1000133,1000025,1000134,1000135,1000136,1000025,1000092,1000137,1000138,1000030,1000015,1000001,1000139,1000140,1000001,1000141,1000142,1000001]}],"gitInfo":{"noRepoFound":true},"kind":"KIND_ADDED"}