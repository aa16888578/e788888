"use strict";var __awaiter=this&&this.__awaiter||function(e,r,o,t){return new(o||(o=Promise))((function(n,s){function c(e){try{a(t.next(e))}catch(e){s(e)}}function i(e){try{a(t.throw(e))}catch(e){s(e)}}function a(e){var r;e.done?n(e.value):(r=e.value,r instanceof o?r:new o((function(e){e(r)}))).then(c,i)}a((t=t.apply(e,r||[])).next())}))},__generator=this&&this.__generator||function(e,r){var o,t,n,s,c={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return s={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function i(i){return function(a){return function(i){if(o)throw new TypeError("Generator is already executing.");for(;s&&(s=0,i[0]&&(c=0)),c;)try{if(o=1,t&&(n=2&i[0]?t.return:i[0]?t.throw||((n=t.return)&&n.call(t),0):t.next)&&!(n=n.call(t,i[1])).done)return n;switch(t=0,n&&(i=[2&i[0],n.value]),i[0]){case 0:case 1:n=i;break;case 4:return c.label++,{value:i[1],done:!1};case 5:c.label++,t=i[1],i=[0];continue;case 7:i=c.ops.pop(),c.trys.pop();continue;default:if(!((n=(n=c.trys).length>0&&n[n.length-1])||6!==i[0]&&2!==i[0])){c=0;continue}if(3===i[0]&&(!n||i[1]>n[0]&&i[1]<n[3])){c.label=i[1];break}if(6===i[0]&&c.label<n[1]){c.label=n[1],n=i;break}if(n&&c.label<n[2]){c.label=n[2],c.ops.push(i);break}n[2]&&c.ops.pop(),c.trys.pop();continue}i=r.call(e,c)}catch(e){i=[6,e],t=0}finally{o=n=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}};Object.defineProperty(exports,"__esModule",{value:!0});var cp=require("child_process"),fs=require("fs"),util_1=require("util"),SHUTDOWN_TIMEOUT_MS=15e3,logger=console,exec=(0,util_1.promisify)(cp.exec),isWindows="win32"===process.platform;if(process.env.CURSOR_LOG_FILE){var outputLog=fs.createWriteStream(process.env.CURSOR_LOG_FILE);console.log("Logging to ".concat(process.env.CURSOR_LOG_FILE)),logger=new console.Console(outputLog,outputLog)}function main(){return __awaiter(this,void 0,void 0,(function(){var e,r,o,t,n,s,c,i,a,u,l,f,p,g,h,_,d,w=this;return __generator(this,(function(v){switch(v.label){case 0:if(e="true"===process.env.CURSOR_IS_DOCKER_COMPOSE,!(r=process.env.CURSOR_DOCKER_ARGS))throw new Error("CURSOR_DOCKER_ARGS is not set");if(!(o=process.env.CURSOR_DOCKER_PATH))throw new Error("CURSOR_DOCKER_PATH is not set");if(t=JSON.parse(r),!(n=process.env.CURSOR_TOKEN_FILE))throw new Error("CURSOR_TOKEN_FILE is not set");if(!(s=process.env.CURSOR_TOKEN))throw new Error("CURSOR_TOKEN is not set");if(!(c=process.env.CURSOR_EXTENSION_HOST_PID))throw new Error("CURSOR_EXTENSION_HOST_PID is not set");i=function(){return __awaiter(w,void 0,void 0,(function(){var e,r;return __generator(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),logger.info("Checking `docker compose version --short`"),[4,exec("".concat(o," compose version --short"),{shell:isWindows?void 0:"bash"})];case 1:return e=t.sent().stdout,logger.info("Docker composer version: ".concat(e)),[3,3];case 2:return r=t.sent(),logger.info("Failed to run ".concat(o," compose version --short"),r),[2,!1];case 3:return[2,!0]}}))}))},a=function(){return __awaiter(w,void 0,void 0,(function(){var e,r;return __generator(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),logger.info("Checking `docker-compose version --short`"),[4,exec("".concat(o,"-compose version --short"),{shell:isWindows?void 0:"bash"})];case 1:return e=t.sent().stdout,logger.info("Docker composer version: ".concat(e)),[3,3];case 2:return r=t.sent(),logger.info("Failed to run ".concat(o,"-compose version --short"),r),[2,!1];case 3:return[2,!0]}}))}))},u="true"===process.env.CURSOR_IS_WSL,logger.log("Shutdown monitor started with token",s),l=0,v.label=1;case 1:return[4,new Promise((function(e){return setTimeout(e,1e3)}))];case 2:v.sent();try{if((p=fs.readFileSync(n,"utf8")).trim()!==s.trim()&&(logger.log("Token mismatch. New token is ".concat(p," (original ").concat(s,"). Exiting.")),process.exit(0)),f=parseInt(c),u){if(cp.execSync('tasklist.exe /FI "PID eq '.concat(f,'"')).includes(f.toString()))return l=0,[3,1]}else try{return process.kill(f,0),l=0,[3,1]}catch(e){}return logger.info("Detected process exit"),[3,3]}catch(e){logger.error("Error in shutdown monitor: ".concat(e)),(l+=1)>=5&&(logger.error("Detected more than 5 errors; exiting"),process.exit(1))}return[3,1];case 3:return[4,new Promise((function(e){return setTimeout(e,SHUTDOWN_TIMEOUT_MS)}))];case 4:return v.sent(),(p=fs.readFileSync(n,"utf8")).trim()!==s.trim()&&(logger.log("Token mismatch. New token is ".concat(p," (original ").concat(s,"). Exiting.")),process.exit(0)),isWindows?g=t.map((function(e){return'"'.concat(e,'"')})).join(" "):(h=function(e){return e.replace(/'/g,"'\\''")},g=t.map((function(e){return"'".concat(h(e),"'")})).join(" ")),e?[4,i()]:[3,9];case 5:return v.sent()?(_="".concat(o," compose ").concat(g),[3,8]):[3,6];case 6:return[4,a()];case 7:if(!v.sent())return logger.error("Could not find docker compose executable; skipping container shutdown"),[2];_="".concat(o,"-compose ").concat(g),v.label=8;case 8:return[3,10];case 9:_="".concat(o," ").concat(g),v.label=10;case 10:return logger.info("Sending shutdown command: ".concat(_)),[4,exec(_,{shell:isWindows?void 0:"bash"})];case 11:return d=v.sent().stdout,logger.info("Shutdown stdout: ".concat(d)),process.exit(0),[2]}}))}))}main().catch((function(e){logger.error(e),process.exit(1)}));