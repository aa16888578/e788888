"use strict";var H=Object.create;var T=Object.defineProperty;var L=Object.getOwnPropertyDescriptor;var z=Object.getOwnPropertyNames;var J=Object.getPrototypeOf,_=Object.prototype.hasOwnProperty;var j=(e,s)=>{for(var t in s)T(e,t,{get:s[t],enumerable:!0})},k=(e,s,t,n)=>{if(s&&typeof s=="object"||typeof s=="function")for(let o of z(s))!_.call(e,o)&&o!==t&&T(e,o,{get:()=>s[o],enumerable:!(n=L(s,o))||n.enumerable});return e};var v=(e,s,t)=>(t=e!=null?H(J(e)):{},k(s||!e||!e.__esModule?T(t,"default",{value:e,enumerable:!0}):t,e)),V=e=>k(T({},"__esModule",{value:!0}),e);var ce={};j(ce,{activate:()=>se,deactivate:()=>te});module.exports=V(ce);var a=v(require("vscode"));var b=v(require("https")),Y="https://cursor.com/api";async function D(e,s,t,n){let o=`${Y}/${s}`;console.log(`[Cursor Usage] Making ${e} request to ${s}`);let d={method:e,headers:{"Content-Type":"application/json",Cookie:`WorkosCursorSessionToken=${t}`,Origin:"https://cursor.com"}};return new Promise((g,l)=>{let c=b.request(o,d,r=>{let u="";r.on("data",m=>{u+=m}),r.on("end",()=>{try{if(r.statusCode&&r.statusCode>=200&&r.statusCode<300){let m=JSON.parse(u);g(m)}else console.error(`[Cursor Usage] HTTP error ${r.statusCode} for ${o}: ${u}`),l(new Error(`HTTP ${r.statusCode}: ${u}`))}catch(m){console.error(`[Cursor Usage] Failed to parse response for ${o}: ${m}`),l(new Error(`Failed to parse response: ${m}`))}})});if(c.on("error",r=>{console.error(`[Cursor Usage] ${e} request failed for ${o}: ${r.message}`),l(r)}),e==="POST"&&n){let r=JSON.stringify(n);c.write(r)}c.end()})}async function U(e,s,t){return D("POST",e,s,t)}async function x(e,s){return D("GET",e,s)}async function M(e){return U("dashboard/teams",e,{})}async function R(e,s){return U("dashboard/team",s,{teamId:e})}async function B(e,s){return U("dashboard/get-team-spend",s,{teamId:e})}async function P(e){return x("auth/me",e)}async function F(e,s){return x(`usage?user=${e}`,s)}var C=v(require("vscode")),i;function E(){i=C.window.createStatusBarItem(C.StatusBarAlignment.Left,100),i.command="cursorUsage.refresh",i.tooltip="Remaining Cursor fast-premium requests",i.text="$(zap) Loading...",i.show()}function O(e,s,t,n,o){if(!i)return;let d=s*.1,g="$(zap)";i.backgroundColor=void 0;let l=!1,c=!1;if(t!==void 0&&n!==void 0){let f=t/100;l=f/n>=.8,c=f>=n}let r=!1,u=!1;e>0?(u=e<=d,r=!1):(r=c,u=l&&!c),r?(g="$(error)",i.backgroundColor=new C.ThemeColor("statusBarItem.errorBackground")):u&&(g="$(warning)",i.backgroundColor=new C.ThemeColor("statusBarItem.warningBackground"));let m;if(e>0)m=`${g} ${e}`;else if(t!==void 0&&n!==void 0){let f=(t/100).toFixed(2),p=n.toFixed(2);m=`${g} $${f}/$${p}`}else m=`${g} 0`;i.text=m,Q(e,s,t,n,o)}function Q(e,s,t,n,o){if(!i)return;let d=s-e,g=(d/s*100).toFixed(1),l=0,c=0;if(o&&o.daysRemaining>0){let u=new Date(o.resetDate);u.setMonth(u.getMonth()-1),l=Math.ceil((o.resetDate.getTime()-u.getTime())/(1e3*3600*24))-o.daysRemaining,l>0&&(c=parseFloat((d/l).toFixed(1)))}let r="";if(o){let u=o.daysRemaining===1?`Resets tomorrow (${o.resetDateStr})`:o.daysRemaining===0?`Resets today (${o.resetDateStr})`:`Resets in ${o.daysRemaining} days (${o.resetDateStr})`;if(c>0&&(u+=` \xB7 ${c} requests/day avg`),r=`${u}
`,e>0&&c>0){let m=Math.ceil(e/c);m<o.daysRemaining&&(r+=`\u26A0\uFE0F At current rate, quota exhausted in ~${m} days
`)}r+=`
`}if(r+=`Fast Premium Requests: ${e}/${s} remaining (${g}% used)`,t!==void 0&&n!==void 0){let u=t/100,m=(u/n*100).toFixed(1),f=(n-u).toFixed(2);r+=`
Spending: $${u.toFixed(2)} of $${n.toFixed(2)} limit (${m}% used)`,r+=`
Remaining budget: $${f}`,e>0?e<=s*.1&&(r+=`
\u26A0\uFE0F Low on requests`):u>=n?r+=`
\u26A0\uFE0F Spend limit reached`:u/n>=.8&&(r+=`
\u26A0\uFE0F Approaching spend limit`)}else e<=0?r+=`
\u26A0\uFE0F No requests remaining`:e<=s*.1&&(r+=`
\u26A0\uFE0F Low on requests`);r+=`

Click to refresh`,i.tooltip=r}function N(e){if(!i)return;let s=e||"Error";i.text=`$(error) ${s}`,i.backgroundColor=new C.ThemeColor("statusBarItem.errorBackground"),s==="Team ID?"?(i.command="cursorUsage.openSettings",i.tooltip="Click to set your Team ID in settings"):(i.command="cursorUsage.refresh",i.tooltip="Click to refresh usage data")}function q(e){i&&(i.text=`$(warning) ${e}`,i.backgroundColor=new C.ThemeColor("statusBarItem.warningBackground"),e==="Set Cookie"?(i.command="cursorUsage.insertCookie",i.tooltip="Click to set your Cursor session cookie"):(i.command="cursorUsage.refresh",i.tooltip="Click to refresh usage data"))}function A(){return i}var S=v(require("vscode")),W="cursorUsage";function $(){return S.workspace.getConfiguration(W).get("teamId")}function I(){return S.workspace.getConfiguration(W).get("pollMinutes",30)}var h;function ee(e){let s=new Date(e),t=new Date(s);t.setMonth(t.getMonth()+1);let n=new Date,o=t.getTime()-n.getTime(),d=Math.ceil(o/(1e3*3600*24)),g=t.toISOString().split("T")[0];return{resetDate:t,daysRemaining:d,resetDateStr:g}}function se(e){console.log("[Cursor Usage] Extension is now active."),E();let s=a.commands.registerCommand("cursorUsage.insertCookie",()=>oe(e)),t=a.commands.registerCommand("cursorUsage.refresh",()=>w(e)),n=a.commands.registerCommand("cursorUsage.openSettings",re),o=a.commands.registerCommand("cursorUsage.forceRefresh",()=>ae(e)),d=a.commands.registerCommand("cursorUsage.setTeamId",ie),g=a.commands.registerCommand("cursorUsage.setPollMinutes",ue);e.subscriptions.push(A(),s,t,n,o,d,g),w(e),y(e);let l=a.workspace.onDidChangeConfiguration(c=>{let r=!1;c.affectsConfiguration("cursorUsage.pollMinutes")&&y(e),c.affectsConfiguration("cursorUsage.teamId")&&($()&&e.workspaceState.update("cursor.teamId",void 0),r=!0),r&&w(e)});e.subscriptions.push(l)}function te(){console.log("[Cursor Usage] Extension is now deactivated."),h&&clearInterval(h)}async function oe(e){try{let s=await a.window.showInputBox({prompt:"Enter your WorkosCursorSessionToken cookie value",placeHolder:"Paste cookie value here...",password:!0,ignoreFocusOut:!0});s&&s.trim()?(await e.secrets.store("cursor.cookie",s.trim()),a.window.showInformationMessage("Cookie saved successfully!"),await w(e)):a.window.showWarningMessage("No cookie value provided.")}catch(s){console.error(`[Cursor Usage] Failed to save cookie: ${s.message}`),a.window.showErrorMessage(`Failed to save cookie: ${s.message}`)}}function re(){a.commands.executeCommand("workbench.action.openSettings","@ext:cursor-usage.cursor-usage")}async function w(e){console.log("[Cursor Usage] Attempting to refresh usage...");try{let s=await e.secrets.get("cursor.cookie");if(!s){q("Set Cookie"),a.window.showWarningMessage('Cursor cookie not found. Use "Cursor Usage Extension: Insert cookie value" command to set it.');return}let t=await P(s);console.log(`[Cursor Usage] Fetched user info for: ${t.email}`);let n=await F(t.sub,s);console.log(`[Cursor Usage] Fetched usage data for user: ${t.sub}`);let o=await ne(e,s),d,g=n["gpt-4"].maxRequestUsage||500;if(o)try{let p=await R(o,s);d=(await B(o,s)).teamMemberSpend.find(G=>G.userId===p.userId)}catch(p){console.warn(`[Cursor Usage] Failed to fetch team data: ${p.message}`)}let l,c,r;!d||typeof d.fastPremiumRequests!="number"?(l=n["gpt-4"].numRequests,c=void 0,r=void 0):(l=d.fastPremiumRequests,c=d.spendCents,r=d.hardLimitOverrideDollars);let u=Math.max(0,g-l),m=ee(n.startOfMonth);O(u,g,c,r,m);let f=`[Cursor Usage] Successfully updated status bar. Remaining requests: ${u}/${g}, Resets in ${m.daysRemaining} days`;if(c!==void 0&&r!==void 0){let p=(c/100).toFixed(2);f+=`, spend: $${p}/$${r.toFixed(2)}`}console.log(f)}catch(s){N("Refresh Failed"),console.error(`[Cursor Usage] Failed to refresh Cursor usage: ${s.message}`)}}async function ne(e,s){let t=$();if(t&&t.toLowerCase()==="auto")await a.workspace.getConfiguration("cursorUsage").update("teamId","",a.ConfigurationTarget.Global);else if(t&&!isNaN(parseInt(t,10))){let o=parseInt(t,10);return console.log(`[Cursor Usage] Using Team ID from settings: ${o}`),o}let n=e.workspaceState.get("cursor.teamId");if(n)return console.log(`[Cursor Usage] Using cached Team ID: ${n}`),n;console.log("[Cursor Usage] Team ID not in settings or cache, attempting to fetch automatically.");try{let o=await M(s);if(o&&o.teams&&o.teams.length>0){let d=o.teams[0].id;return console.log(`[Cursor Usage] Automatically detected and cached Team ID: ${d}`),await e.workspaceState.update("cursor.teamId",d),d}console.warn("[Cursor Usage] No teams found for this user.");return}catch(o){console.error(`[Cursor Usage] Failed to auto-detect Team ID: ${o.message}`);return}}function y(e){h&&clearInterval(h);let s=I(),t=s*60*1e3;h=setInterval(()=>{w(e)},t),console.log(`[Cursor Usage] Refresh timer set to ${s} minutes.`)}async function ae(e){console.log("[Cursor Usage] Forcing a full refresh..."),await e.workspaceState.update("cursor.teamId",void 0),console.log("[Cursor Usage] Cleared cached Team ID."),y(e),await w(e),a.window.showInformationMessage("Cursor Usage extension has been re-initialized.")}async function ie(){let e=await a.window.showInputBox({prompt:"(Optional) Your Cursor Team ID. Leave empty or set to 'auto' to auto-detect.",placeHolder:"Enter your Team ID or 'auto'",value:$()||""});e!==void 0&&(await a.workspace.getConfiguration("cursorUsage").update("teamId",e,a.ConfigurationTarget.Global),a.window.showInformationMessage(`Cursor Team ID set to: ${e||"auto"}`))}async function ue(){let e=await a.window.showInputBox({prompt:"How often to refresh the remaining requests count (in minutes)",placeHolder:"Enter a number in minutes",value:String(I()),validateInput:s=>{let t=parseInt(s,10);return isNaN(t)||t<=0?"Please enter a positive number.":null}});e!==void 0&&(await a.workspace.getConfiguration("cursorUsage").update("pollMinutes",parseInt(e,10),a.ConfigurationTarget.Global),a.window.showInformationMessage(`Cursor poll interval set to: ${e} minutes.`))}0&&(module.exports={activate,deactivate});
